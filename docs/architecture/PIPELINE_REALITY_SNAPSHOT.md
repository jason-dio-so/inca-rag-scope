# PIPELINE REALITY SNAPSHOT — inca-rag-scope

**Date**: 2025-12-30
**Branch**: `feat/step-next-14-chat-ui`
**Last Commit**: `2fd59c9 feat(step-next-19): hanwha/heungkuk amount extraction stabilization`

**⚠️ CRITICAL**: This snapshot is for **inca-rag-scope** ONLY. Do NOT mix with `inca-rag-demo(U-4.16)` context.

---

## STEP A) Repo Context

```
pwd: /Users/cheollee/inca-rag-scope
git status: ## feat/step-next-14-chat-ui
untracked: docs/architecture/
```

**This work is performed exclusively in `inca-rag-scope`.**

---

## STEP B) Active Pipeline Entrypoints (Evidence-Based)

### Entrypoints with `if __name__ == "__main__":`

| Step Directory | Entry File | Input Artifacts | Output Artifacts | SSOT Related | Status |
|---|---|---|---|---|---|
| `step0_scope_filter` | `filter_scope_mapped.py` | `*_scope_mapped.csv` | `*_scope_mapped.sanitized.csv`, `*_scope_filtered_out.jsonl` | ✅ INPUT contract | Active |
| `step0_scope_filter` | `coverage_candidate_filter.py` | `*_proposal*.page.jsonl` | `*_scope.csv`, `*_filtered_out.jsonl` | ❌ | Active |
| `step1_extract_scope` | `run.py` | PDF (proposals) | `*_scope.csv` | ❌ | Active |
| `step1_sanitize_scope` | `run.py` | `*_scope_mapped.csv` | `*_scope_mapped.sanitized.csv` | ✅ INPUT contract | **Active** |
| `step2_canonical_mapping` | `map_to_canonical.py` | `*_scope.csv` | `*_scope_mapped.csv` | ❌ | Active |
| `step3_extract_text` | `extract_pdf_text.py` | PDF files | `*.page.jsonl` | ❌ | Active |
| `step4_evidence_search` | `search_evidence.py` | `*_scope_mapped.sanitized.csv`, `*.page.jsonl` | `*_evidence_pack.jsonl`, `*_unmatched_review.csv` | ❌ | Active |
| `step5_build_cards` | `build_cards.py` | `*_scope_mapped.sanitized.csv`, `*_evidence_pack.jsonl` | `*_coverage_cards.jsonl` | ✅ **SSOT Generation** | **Active** |
| `step7_amount_extraction` | `extract_and_enrich_amounts.py` | `*_coverage_cards.jsonl`, `*_proposal*.page.jsonl` | `*_coverage_cards.jsonl` (enriched) | ✅ SSOT enrichment | **Active (STEP19)** |
| `step7_compare` | `compare_insurers.py` | `*_coverage_cards.jsonl` (2+ insurers) | `*_vs_*_compare.jsonl`, `compare_stats.json` | ❌ | Active (output only) |
| `step8_multi_compare` | `compare_all_insurers.py` | `*_coverage_cards.jsonl` (3+) | `all_insurers_matrix.json`, `all_insurers_stats.json` | ❌ | Active (output only) |
| `step8_single_coverage` | `extract_single_coverage.py` | `*_coverage_cards.jsonl` | `*_single_coverage_profile.json` | ❌ | Active (API helper) |
| `step10_audit` | `audit_step7_amount_gt.py` | `*_coverage_cards.jsonl`, `*_proposal*.page.jsonl` | `docs/audit/AMOUNT_STATUS_DASHBOARD.md` | ✅ **Audit SSOT** | **DEPRECATED** (STEP18X) |

### Mixed/Overlapping Steps

| Issue | Steps Involved | Root Cause |
|---|---|---|
| **Proposal extraction** | `step0_scope_filter/coverage_candidate_filter.py`, `step1_extract_scope/run.py` | Both extract from proposal PDFs; no clear single entrypoint |
| **Scope sanitization** | `step0_scope_filter/filter_scope_mapped.py`, `step1_sanitize_scope/run.py` | Both produce `*_scope_mapped.sanitized.csv`; unclear which is canonical |
| **Evidence → Cards** | `step4_evidence_search`, `step5_build_cards` | Tight coupling; step4 output is step5 input |

### Execution Prohibition (from CLAUDE.md)

- `step6_build_report`: REMOVED (replaced by coverage_cards)
- `step7_compare`: **Execution prohibited** (JSONL output only)
- `step8_multi_compare`: **Execution prohibited** (stats only)
- `step9_*`, `step10_*`: DEPRECATED (step10_audit deprecated in STEP18X-SSOT-FINAL-A)

---

## STEP C) SSOT vs Actual Write Locations

### SSOT Definition (from CLAUDE.md:25-40)

**Coverage SSOT**:
```
data/compare/*_coverage_cards.jsonl
```
- Generated by: `pipeline/step5_build_cards/build_cards.py:247`
- Enriched by: `pipeline/step7_amount_extraction/extract_and_enrich_amounts.py:431`

**Audit SSOT** (DEPRECATED):
```
docs/audit/AMOUNT_STATUS_DASHBOARD.md
```
- Generated by: `pipeline/step10_audit/audit_step7_amount_gt.py:729`
- **Status**: DEPRECATED in STEP18X-SSOT-FINAL-A (per CLAUDE.md:70)

### Actual Write Operations

| File Pattern | Writer | SSOT? | Notes |
|---|---|---|---|
| `data/scope/*_scope_mapped.sanitized.csv` | `step1_sanitize_scope/run.py:140` | ✅ INPUT contract | Single source |
| `data/scope/*_filtered_out.jsonl` | `step1_sanitize_scope/run.py:170` | ❌ | Audit log |
| `data/compare/*_coverage_cards.jsonl` | `step5_build_cards/build_cards.py:247` | ✅ **SSOT** | Canonical coverage data |
| `data/compare/*_coverage_cards.jsonl` | `step7_amount_extraction/extract_and_enrich_amounts.py:431` | ✅ SSOT (enrichment) | Overwrites with amount field |
| `data/compare/*_vs_*_compare.jsonl` | `step7_compare/compare_insurers.py:169` | ❌ | Output only |
| `data/compare/compare_stats.json` | `step7_compare/compare_insurers.py:175` | ❌ | Output only |
| `data/compare/all_insurers_matrix.json` | `step8_multi_compare/compare_all_insurers.py:306` | ❌ | Output only |
| `docs/audit/AMOUNT_STATUS_DASHBOARD.md` | `step10_audit/audit_step7_amount_gt.py:729` | ❌ DEPRECATED | STEP18X removed |

### Prohibited Outputs (Confirmed Removed)

```bash
# grep -n "reports/" pipeline
pipeline/step8_multi_compare/compare_all_insurers.py:3:STEP NEXT-18X-SSOT: NO reports/
pipeline/step7_compare/compare_insurers.py:2:Step 7: Compare Insurers (STEP NEXT-18X-SSOT: NO reports/)
```

✅ **No `reports/` directory writes** — confirmed removed in STEP18X-SSOT.

---

## STEP D) STEP19 "Multiline Amount Fragment Merge" Evidence

### Code Evidence

**Function Definition**: `pipeline/step7_amount_extraction/extract_and_enrich_amounts.py:162-192`

```python
def merge_amount_fragments(lines: List[str], start_idx: int) -> Tuple[Optional[str], int]:
    """
    STEP NEXT-19: Merge multi-line amount fragments

    Example: "1," on line N + "000만원" on line N+1 → "1,000만원"
    """
    comma_match = re.fullmatch(r'(\d+),', first_line)
    if comma_match and start_idx + 1 < len(lines):
        next_line = lines[start_idx + 1].strip()
        unit_match = re.fullmatch(r'(\d{3})(만?원)', next_line)
        if unit_match:
            merged = f"{comma_match.group(1)},{unit_match.group(1)}{unit_match.group(2)}"
            return merged, 2
    return None, 0
```

**Calling Context**: `pipeline/step7_amount_extraction/extract_and_enrich_amounts.py:238`

```python
merged_amount, consumed = merge_amount_fragments(lines, i)
```

**Applied To**: `hanwha`, `heungkuk` (based on file path evidence)

### Data Evidence — Proposal Files

**Hanwha Proposal** (`data/evidence_text/hanwha/가입설계서/한화_가입설계서_2511.page.jsonl`):

- **Page 3, Line 22**: `"1,\n000만원"` → Pattern detected
- **Page 3, Line 33**: `"1,\n000만원"` → Pattern detected
- **Page 3, Line 55**: `"3,\n000만원"` → Pattern detected
- **Actual text from proposal page 3** (excerpt):
```
가입담보    가입금액    보험료
보통약관(상해사망)    1,
000만원    590원
...
암(4대유사암제외)진단비    3,
000만원    34,230원
```

**Heungkuk Proposal** (`data/evidence_text/heungkuk/가입설계서/흥국_가입설계서_2511.page.jsonl`):

- **Similar patterns found** in table amounts

### Original PDF Evidence (Inferred)

The **source PDF** table formatting splits amounts across lines when rendered as text:

| Coverage Name | Amount | Premium |
|---|---|---|
| 보통약관(상해사망) | 1,<br>000만원 | 590원 |

**Text extraction** (via `pdfplumber`/`pymupdf`) outputs:
```
보통약관(상해사망)
1,
000만원
590원
```

**STEP19 logic** merges `"1,"` + `"000만원"` → `"1,000만원"`.

### Conclusion

✅ **STEP19 multiline fragment merge is REAL and SUPPORTED by evidence**:

1. **Code exists**: `merge_amount_fragments()` at `extract_and_enrich_amounts.py:162`
2. **Data evidence**: Hanwha/Heungkuk proposal `.page.jsonl` files contain `"N,\n000만원"` patterns
3. **Root cause**: PDF table text extraction splits amounts across newlines
4. **Impact**: Without STEP19, amounts like `"1,000만원"` would fail to extract

**KPI Impact**: Likely stabilized hanwha/heungkuk amount extraction (per commit `2fd59c9`).

---

## STEP E) STEP NEXT-20 "유사암/경계담보 Canonical Expansion" Reality Check

### Grep Evidence

```bash
# grep -rn "STEP NEXT-20|유사암|경계성|제자리암|borderline|in\s*situ|A4210" .
```

**Findings**:

1. **A4210 (유사암진단비)**: PRESENT in:
   - `STATUS.md.backup:1353`: Listed as A4210
   - `STATUS.md.backup:1363`: "유사암진단비 (A4210)"
   - Coverage cards (`data/compare/*_coverage_cards.jsonl`) do NOT contain A4210 entries

2. **제자리암/경계성종양**: PRESENT in:
   - Proposal files (한화/흥국) list "제자리암", "경계성종양" as separate coverage
   - `STEP_NEXT_18B_COMPLETION.md:124`: Mentions "4대특정암 진단비(제자리암)" as A4209_3
   - `docs/run/STEP4I_HANWHA_MATCHED_EMPTY.csv`: Shows A4209_3, A4209_6 with **0 evidence hits**

3. **STEP NEXT-20 keyword**: **NOT FOUND** in codebase

### Mapping File Evidence

```bash
# grep -E "A4210|A4209" data/sources/mapping/*.xlsx
```

**Result**: No grep output (binary file). Manual inspection required.

### Conclusion

❌ **STEP NEXT-20 (canonical expansion) NOT IMPLEMENTED in inca-rag-scope**:

- **Evidence**: No code/config references to "STEP NEXT-20"
- **Partial coverage**: "제자리암"/"경계성종양" exist in proposals but:
  - Mapped to A4209_3/A4209_6 (not A4210)
  - Have **0 evidence hits** (step4 search failed)
- **U-4.16 confusion**: STEP NEXT-20 may have been implemented in `inca-rag-demo` repo, NOT here

**Recommendation**: Treat STEP NEXT-20 as "planned but not executed" in inca-rag-scope.

---

## STEP F) Ordered Next Actions

See [`NEXT_ACTIONS_ORDERED.md`](./NEXT_ACTIONS_ORDERED.md).
