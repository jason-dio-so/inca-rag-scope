# STEP NEXT-10-Œ≤1: DB Ï†ÑÏàò Ï†êÍ≤Ä(Audit) Î≥¥Í≥†ÏÑú

**ÏûëÏÑ±Ïùº**: 2025-12-28
**Î™©Ï†Å**: DB Ïò§Ïóº Ïã§ÌÉú ÌôïÏ†ï ‚Üí Case ÌåêÏ†ï ‚Üí ÏàòÏ†ï Í≥ÑÌöç ÏàòÎ¶Ω
**Í≤∞Î°†**: **Case 1 ÌôïÏ†ï** (amount_factÎßå Ïò§Ïóº, Loader ÏàòÏ†ï ÌïÑÏöî)

---

## 1. ÌÖåÏù¥Î∏îÎ≥Ñ Row Count

| ÌÖåÏù¥Î∏î | Row Count | ÏÉÅÌÉú |
|--------|-----------|------|
| coverage_canonical | 48 | ‚úÖ Ï†ïÏÉÅ |
| insurer | 8 | ‚úÖ Ï†ïÏÉÅ |
| product | 8 | ‚úÖ Ï†ïÏÉÅ |
| product_variant | 4 | ‚úÖ Ï†ïÏÉÅ |
| document | 38 | ‚úÖ Ï†ïÏÉÅ |
| coverage_instance | 297 | ‚úÖ Ï†ïÏÉÅ |
| evidence_ref | 747 | ‚ö†Ô∏è Î™©Ï∞®ÏÑ± snippet Îã§Ïàò (ÌóàÏö© Î≤îÏúÑ) |
| amount_fact | 297 | ‚ùå **Ïã¨Í∞ÅÌïú Ïò§Ïóº** |

---

## 2. coverage_instance ÌíàÏßà ÏöîÏïΩ

### 2.1 mapping_status Î∂ÑÌè¨
| Status | Count | ÎπÑÏú® |
|--------|-------|------|
| matched | 218 | 73.4% |
| unmatched | 79 | 26.6% |

### 2.2 coverage_code NULL ÎπÑÏú®
| Metric | Value |
|--------|-------|
| NULL count | 79 |
| Total | 297 |
| NULL % | **26.60%** |

**Î∂ÑÏÑù**:
- ‚úÖ unmatched (79Í∞ú) = coverage_code NULL (79Í∞ú) ‚Üí Ï†ïÌï©ÏÑ± Ïú†ÏßÄ
- ‚úÖ matched Îã¥Î≥¥Îäî Î™®Îëê coverage_code Î≥¥Ïú†
- ‚úÖ instance_key Ï§ëÎ≥µ 0Í±¥

### 2.3 coverage_name_raw ÏÉòÌîå (Í∏∏Ïù¥ ÏÉÅÏúÑ 20Í∞ú)

Í∞ÄÏû• Í∏¥ Îã¥Î≥¥Î™Ö (53Ïûê):
```
[Í∞±Ïã†Ìòï]Îã§ÎπàÏπòÎ∞èÎ†àÎ≥¥ÏïÑÏù¥Î°úÎ¥á ÏïîÏàòÏà†ÎπÑ(Í∞ëÏÉÅÏÑ†Ïïî Î∞è Ï†ÑÎ¶ΩÏÑ†Ïïî Ï†úÏô∏)(ÏµúÏ¥à1ÌöåÌïú)(Í∞±Ïã†Ìòï_10ÎÖÑ)
```

**Î∂ÑÏÑù**:
- ‚ö†Ô∏è ÏùºÎ∂Ä Îã¥Î≥¥Î™ÖÏù¥ Í≥ºÎèÑÌïòÍ≤å Í∏∏ÏßÄÎßå (40Ïûê Ïù¥ÏÉÅ)
- ‚úÖ "Î™©Ï∞®/Ï°∞Ìï≠" ÌÖçÏä§Ìä∏Îäî ÏïÑÎãò
- ‚úÖ coverage_instanceÎäî **Ï†ïÏÉÅ**

---

## 3. evidence_ref ÌíàÏßà ÏöîÏïΩ

### 3.1 doc_type Î∂ÑÌè¨
| doc_type | Count | ÎπÑÏú® |
|----------|-------|------|
| ÏïΩÍ¥Ä | 733 | 98.1% |
| ÏÇ¨ÏóÖÎ∞©Î≤ïÏÑú | 7 | 0.9% |
| ÏÉÅÌíàÏöîÏïΩÏÑú | 7 | 0.9% |

**Î∂ÑÏÑù**:
- ‚ö†Ô∏è ÏïΩÍ¥Ä Ìé∏Ï§ë (98.1%)
- ‚ö†Ô∏è ÏÇ¨ÏóÖÎ∞©Î≤ïÏÑú/ÏÉÅÌíàÏöîÏïΩÏÑú Í∑πÏÜå (Í∞Å 7Í±¥)
- üìå **Doc-type diversity ÏõêÏπô ÏúÑÎ∞ò Í∞ÄÎä•ÏÑ±** (STEP6E Í∏∞Ï§Ä)

### 3.2 snippet Í∏∏Ïù¥ ÌÜµÍ≥Ñ
| Metric | Value |
|--------|-------|
| MIN | 13Ïûê |
| MAX | 500Ïûê |
| AVG | 245Ïûê |
| MEDIAN | 244Ïûê |
| Over 500Ïûê | 0Í±¥ |

**Î∂ÑÏÑù**:
- ‚úÖ Î™®Îì† snippetÏù¥ 500Ïûê Ïù¥ÎÇ¥ (truncate Í∑úÏπô Ï§ÄÏàò)
- ‚úÖ ÌèâÍ∑† Í∏∏Ïù¥ Ï†ÅÏ†ï (245Ïûê)

### 3.3 Î™©Ï∞®ÏÑ± snippet ÏÉòÌîå (30Í∞ú)

**Ìå®ÌÑ¥**: `(Î™©Ï∞®|ÌäπÏïΩÍ¥Ä|ÌäπÎ≥ÑÏïΩÍ¥Ä|ÎØºÏõêÏÇ¨Î°Ä|ÏïàÎÇ¥|ÏòàÏãú|FAQ)`

**ÏÉòÌîå (ÏùºÎ∂Ä)**:
```
"2-137. Í∞ëÏÉÅÏÑ†Í∏∞Îä•Ìï≠ÏßÑÏ¶ùÏπòÎ£åÎπÑ(1ÌöåÌïú,Í∏âÏó¨) ÌäπÎ≥ÑÏïΩÍ¥Ä¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑428"
"2-158 ÏßàÎ≥ëÏûÖÏõêÏùºÎãπ(1-30Ïùº,ÏÉÅÍ∏âÏ¢ÖÌï©Î≥ëÏõê,2~3Ïù∏Ïã§)Î≥¥Ïû• ÌäπÎ≥ÑÏïΩÍ¥Ä / ÏßàÎ≥ëÏûÖÏõêÏùºÎãπ..."
"ÎØºÏõêÏÇ¨Î°Ä AÏî®Îäî ÏïîÎ≥¥Ìóò Í∞ÄÏûÖ ÌõÑ 2Í∞úÏõîÏù¥ ÏßÄÎÇòÏÑú ÏúÑÏïîÏùÑ ÌåêÏ†ïÎ∞õÏïÑ Î≥¥ÌóòÌöåÏÇ¨Ïóê Ïïî ÏßÑÎã®ÎπÑÎ•º Ï≤≠Íµ¨..."
```

**Î∂ÑÏÑù**:
- ‚ö†Ô∏è evidence_refÏóê Î™©Ï∞®/ÎØºÏõêÏÇ¨Î°Ä snippet Îã§Ïàò
- ‚úÖ **ÌïòÏßÄÎßå** evidenceÎäî "Í∑ºÍ±∞ ÌÖçÏä§Ìä∏ ÏõêÎ≥∏ Î≥¥Ï°¥"Ïù¥ÎØÄÎ°ú **ÌóàÏö© Î≤îÏúÑ**
- üìå evidence_refÏùò snippetÏùÄ **amount_factÏùò value_textÏôÄ Ïó≠Ìï†Ïù¥ Îã§Î¶Ñ**:
  - `evidence_ref.snippet`: Í∑ºÍ±∞ ÌÖçÏä§Ìä∏ (Î™©Ï∞®/Ï°∞Ìï≠ Ìè¨Ìï® ÌóàÏö©)
  - `amount_fact.value_text`: ÏÇ¨Ïã§ Í∞í (Í∏àÏï°/ÌöüÏàòÎßå ÌóàÏö©)

**Í≤∞Î°†**: evidence_refÎäî **Ï†ïÏÉÅ** (Ïó≠ÏÇ¨Ï†Å Ìï©Ïùò `docs/HISTORY_SCOPE_V1.md` Section 8 Í∏∞Ï§Ä)

---

## 4. amount_fact Ïò§Ïóº ÌÉêÏßÄ (ÌïµÏã¨)

### 4.1 status Î∂ÑÌè¨
| Status | Count | ÎπÑÏú® |
|--------|-------|------|
| UNCONFIRMED | 223 | 75.08% |
| CONFIRMED | 74 | 24.92% |

### 4.2 value_text NULL ÎπÑÏú®
| Metric | Value |
|--------|-------|
| NULL count | 223 |
| Total | 297 |
| NULL % | **75.08%** |

**Î∂ÑÏÑù**:
- ‚ö†Ô∏è 75%Í∞Ä value_text NULL (UNCONFIRMED)
- ‚ö†Ô∏è 74Í∞úÎßå value_text Î≥¥Ïú† (CONFIRMED)

### 4.3 value_text Í∏∏Ïù¥ ÏÉÅÏúÑ 50Í∞ú ÏÉòÌîå

**Î™®Îì† ÏÉòÌîåÏù¥ 200Ïûê (ÏµúÎåÄ Í∏∏Ïù¥)**

**ÏÉòÌîå (ÏùºÎ∂Ä)**:
```
"1-37. ÏÉÅÌï¥Ï§ëÌôòÏûêÏã§ÏûÖÏõêÎπÑ(1Ïùº-30Ïùº) ÌäπÎ≥ÑÏïΩÍ¥Ä¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑"
"2-137. Í∞ëÏÉÅÏÑ†Í∏∞Îä•Ìï≠ÏßÑÏ¶ùÏπòÎ£åÎπÑ(1ÌöåÌïú,Í∏âÏó¨) ÌäπÎ≥ÑÏïΩÍ¥Ä¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑428"
"ÎØºÏõêÏÇ¨Î°Ä AÏî®Îäî ÏïîÎ≥¥Ìóò Í∞ÄÏûÖ ÌõÑ 2Í∞úÏõîÏù¥ ÏßÄÎÇòÏÑú ÏúÑÏïîÏùÑ ÌåêÏ†ïÎ∞õÏïÑ Î≥¥ÌóòÌöåÏÇ¨Ïóê Ïïî ÏßÑÎã®ÎπÑÎ•º Ï≤≠Íµ¨..."
"33. Í∞±Ïã†Ìòï ÏïîÏàòÏà†ÎπÑ(Ïú†ÏÇ¨ÏïîÏ†úÏô∏)Î≥¥Ïû•ÌäπÎ≥ÑÏïΩÍ¥Ä .........................................................................."
```

**Î∂ÑÏÑù**:
- ‚ùå **value_textÏóê Î™©Ï∞®/Ï°∞Ìï≠/ÎØºÏõêÏÇ¨Î°Ä Ï†ÄÏû•Îê®**
- ‚ùå **Í∏àÏï°Ïù¥ ÏïÑÎãå Îç©Ïñ¥Î¶¨ ÌÖçÏä§Ìä∏ Ï†ÄÏû•**
- üö® **Ïó≠ÏÇ¨Ï†Å Ìï©Ïùò ÏúÑÎ∞ò** (`docs/HISTORY_SCOPE_V1.md` Section 7.2)

### 4.4 Í∏àÏßÄ Ìå®ÌÑ¥ Îß§Ïπ≠ Í±¥Ïàò

| Ìå®ÌÑ¥ | Count | ÎπÑÏú® |
|------|-------|------|
| Í∏àÏßÄ Ìå®ÌÑ¥ (ÌäπÏïΩÍ¥Ä/Î™©Ï∞®/ÎØºÏõêÏÇ¨Î°Ä) | 50 | **67.57%** |
| Ï°∞Ìï≠ Ìå®ÌÑ¥ (Ï†úNÏû•/Ï†à/Ï°∞) | 2 | 2.70% |
| Total non-NULL | 74 | 100% |

üö® **67.57%Í∞Ä Í∏àÏßÄ Ìå®ÌÑ¥ Ìè¨Ìï®**

### 4.5 Ï†ïÏÉÅ Ìå®ÌÑ¥ Îß§Ïπ≠ Í±¥Ïàò

| Ìå®ÌÑ¥ | Count | ÎπÑÏú® |
|------|-------|------|
| Í∏àÏï° (ÎßåÏõê/Ïõê/Ï≤úÏõê) | 2 | **2.70%** |
| Í∏∞Í∞Ñ (Ïùº/Í∞úÏõî/ÎÖÑ) | 46 | 62.16% |
| ÌöüÏàò (Ìöå) | 27 | 36.49% |
| Total non-NULL | 74 | 100% |

üö® **2.70%Îßå Ï†ïÏÉÅ Í∏àÏï° Ìå®ÌÑ¥**

---

## 5. Ï¶ùÍ±∞‚ÜíÍ∞í Ïó∞Í≤∞ ÌôïÏù∏ (End-to-End)

### 5.1 A4200_1 (ÏïîÏßÑÎã®ÎπÑ) Ï°∞Ïù∏ ÏÉòÌîå

| Î≥¥ÌóòÏÇ¨ | coverage_code | status | value_text ÏÉòÌîå | evidence_snippet ÏÉòÌîå |
|--------|---------------|--------|----------------|---------------------|
| ÏÇºÏÑ±ÏÉùÎ™Ö | A4200_1 | UNCONFIRMED | NULL | NULL |
| **ÌïúÌôîÏÉùÎ™Ö** | A4200_1 | **CONFIRMED** | **"7\nÎØºÏõêÏÇ¨Î°Ä\nAÏî®Îäî ÏïîÎ≥¥Ìóò..."** | **"7\nÎØºÏõêÏÇ¨Î°Ä\nAÏî®Îäî ÏïîÎ≥¥Ìóò..."** |
| ÌòÑÎåÄÌï¥ÏÉÅ | A4200_1 | UNCONFIRMED | NULL | NULL |
| Ìù•Íµ≠ÏÉùÎ™Ö | A4200_1 | UNCONFIRMED | NULL | NULL |
| Î©îÎ¶¨Ï∏†ÌôîÏû¨ | A4200_1 | UNCONFIRMED | NULL | NULL |
| Î°ØÎç∞ÏÜêÌï¥Î≥¥Ìóò | A4200_1 | UNCONFIRMED | NULL | NULL |
| DBÏÜêÌï¥Î≥¥Ìóò | A4200_1 | UNCONFIRMED | NULL | NULL |
| KBÏÜêÌï¥Î≥¥Ìóò | A4200_1 | UNCONFIRMED | NULL | NULL |

**Î∂ÑÏÑù**:
- üö® **ÌïúÌôîÏÉùÎ™Ö A4200_1**:
  - value_text = "ÎØºÏõêÏÇ¨Î°Ä AÏî®Îäî ÏïîÎ≥¥Ìóò Í∞ÄÏûÖ ÌõÑ 2Í∞úÏõîÏù¥ ÏßÄÎÇòÏÑú ÏúÑÏïîÏùÑ ÌåêÏ†ïÎ∞õÏïÑ..."
  - evidence_snippet = ÎèôÏùº (snippetÏùÑ Í∑∏ÎåÄÎ°ú value_textÏóê Ï†ÄÏû•)
- ‚ùå **value_textÍ∞Ä "Í∏àÏï°"Ïù¥ ÏïÑÎãàÎùº "ÎØºÏõêÏÇ¨Î°Ä ÏÑ§Î™Ö"**

---

## 6. Case ÌåêÏ†ï (1/2/3)

### 6.1 ÌåêÏ†ï Í∏∞Ï§Ä

| Case | Ï¶ùÏÉÅ | ÏõêÏù∏ ÏúÑÏπò |
|------|------|----------|
| Case 1 | amount_factÎßå Ïò§Ïóº | Loader (load_amount_fact) |
| Case 2 | evidence_refÎ∂ÄÌÑ∞ Ïò§Ïóº | Evidence pack ÏÉùÏÑ± Îã®Í≥Ñ |
| Case 3 | coverage_instanceÎ∂ÄÌÑ∞ Î∂ïÍ¥¥ | Coverage mapping Îã®Í≥Ñ |

### 6.2 ÌåêÏ†ï Í≤∞Í≥º

**‚úÖ Case 1 ÌôïÏ†ï: amount_factÎßå Ïò§Ïóº**

**Ï¶ùÍ±∞**:
1. **coverage_instance**: ‚úÖ Ï†ïÏÉÅ
   - mapping_status Ï†ïÌï© Ïú†ÏßÄ
   - coverage_code Ï†ïÌï© Ïú†ÏßÄ
   - instance_key Ï§ëÎ≥µ 0Í±¥

2. **evidence_ref**: ‚úÖ Ï†ïÏÉÅ (Ïó≠ÏÇ¨Ï†Å Ìï©Ïùò Í∏∞Ï§Ä)
   - snippetÏùÄ "Í∑ºÍ±∞ ÌÖçÏä§Ìä∏ ÏõêÎ≥∏ Î≥¥Ï°¥"
   - Î™©Ï∞®/Ï°∞Ìï≠ Ìè¨Ìï® ÌóàÏö© (Ïó≠ÏÇ¨Ï†Å Ìï©Ïùò Section 8.1)
   - evidenceÎäî "ÏÇ¨Ïã§Ïùò Í∑ºÍ±∞" Ïó≠Ìï†

3. **amount_fact**: ‚ùå Ïã¨Í∞ÅÌïú Ïò§Ïóº
   - value_textÏóê Î™©Ï∞®/ÎØºÏõêÏÇ¨Î°Ä/Ï°∞Ìï≠ Ï†ÄÏû•
   - 67.57% Í∏àÏßÄ Ìå®ÌÑ¥, 2.70%Îßå Ï†ïÏÉÅ Í∏àÏï°
   - snippetÏùÑ Í∑∏ÎåÄÎ°ú value_textÏóê Ï†ÄÏû• (ÌïúÌôîÏÉùÎ™Ö A4200_1 ÏÇ¨Î°Ä)

**Í≤∞Î°†**:
> **Case 1 ÌôïÏ†ï**
>
> ÏõêÏù∏: Loader (`apps/loader/step9_loader.py:564-627`)Ïùò `load_amount_fact` Ìï®Ïàò
>
> Î¨∏Ï†ú ÏΩîÎìú:
> ```python
> snippet = ev.get('snippet', '')
> if 'ÎßåÏõê' in snippet or 'Ïõê' in snippet:
>     value_text = snippet[:200]  # ‚ùå snippet Í∑∏ÎåÄÎ°ú Ï†ÄÏû•
> ```

---

## 7. ÏõêÏù∏ ÏúÑÏπò ÌôïÏ†ï

### 7.1 Ïò§Ïóº Î∞úÏÉù ÏßÄÏ†ê

**ÌååÏùº**: `apps/loader/step9_loader.py`

**Ìï®Ïàò**: `load_amount_fact` (line 519-663)

**Î¨∏Ï†ú ÏΩîÎìú** (line 574-586):
```python
# Extract amount_text from evidence snippets
amount_text = None
source_doc_type = None

for ev in evidences:
    snippet = ev.get('snippet', '')
    if 'ÎßåÏõê' in snippet or 'Ïõê' in snippet:
        amount_text = snippet[:200]  # ‚ùå snippet Í∑∏ÎåÄÎ°ú Ï†ÄÏû•!
        source_doc_type = ev.get('doc_type', '')
        break

if not amount_text:
    continue
```

**Ïò§Î•ò Î∂ÑÏÑù**:
1. snippet Ï†ÑÏ≤¥Î•º value_textÏóê Ï†ÄÏû•
2. 'ÎßåÏõê' ÎòêÎäî 'Ïõê' Î¨∏ÏûêÎßå Ï≤¥ÌÅ¨ ‚Üí Î™©Ï∞®/ÎØºÏõêÏÇ¨Î°ÄÎèÑ ÌÜµÍ≥º
3. Ï†ïÍ∑úÏãùÏúºÎ°ú Í∏àÏï° Ï∂îÏ∂ú ÏóÜÏùå
4. DB constraint ÏóÜÏùå ‚Üí Ïì∞Î†àÍ∏∞ Ï†ÄÏû• ÌóàÏö©

### 7.2 Ïó≠ÏÇ¨Ï†Å Ìï©Ïùò ÏúÑÎ∞ò ÏÇ¨Ìï≠

**ÏúÑÎ∞ò ÏõêÏπô** (`docs/HISTORY_SCOPE_V1.md`):

**Section 7.2: DBÍ∞Ä Ï†àÎåÄ Ìï¥ÏÑúÎäî Ïïà ÎêòÎäî Ïùº**
```
DB ‚â† Generator:
- ‚ùå Generate canonical codes
- ‚ùå Infer missing amounts
- ‚ùå Calculate amounts from rates
- ‚ùå Summarize evidence snippets  ‚Üê ÏúÑÎ∞ò!
```

**Section 8.2: AmountÏùò Ïó≠Ìï†**
```
amount_fact ÌÖåÏù¥Î∏î: Îã¥Î≥¥Î≥Ñ **Í∏àÏï°/Ï°∞Í±¥ ÏÇ¨Ïã§** Ï†ÄÏû•
- value_text: Í∏àÏï° ÌÖçÏä§Ìä∏ (Ïòà: "3000ÎßåÏõê")  ‚Üê ÏúÑÎ∞ò!
- status: CONFIRMED / UNCONFIRMED
- source_doc_type: Í∞ÄÏûÖÏÑ§Í≥ÑÏÑú Ïö∞ÏÑ† (PRIMARY)
```

**Section 8.2: Î∂ÑÎ¶¨ Ïù¥Ïú†**
```
- EvidenceÎäî "Í∑ºÍ±∞ ÌÖçÏä§Ìä∏"
- AmountÎäî "ÏÇ¨Ïã§ Í∞í"  ‚Üê ÏúÑÎ∞ò!
- Í∞ôÏùÄ evidenceÏóêÏÑú Ïó¨Îü¨ amount Ï∂îÏ∂ú Í∞ÄÎä•
```

---

## 8. Îã§Ïùå Ïï°ÏÖò (ÏàòÏ†ï ÎåÄÏÉÅ)

### 8.1 ÏàòÏ†ï Î≤îÏúÑ

**ÏàòÏ†ï ÌååÏùº**: `apps/loader/step9_loader.py`

**ÏàòÏ†ï Ìï®Ïàò**: `load_amount_fact` (line 519-663)

**ÏàòÏ†ï ÏõêÏπô**:
1. snippetÏóêÏÑú **Í∏àÏï°Îßå Ï∂îÏ∂ú** (Ï†ïÍ∑úÏãù ÏÇ¨Ïö©)
2. Ï∂îÏ∂ú Ïã§Ìå® Ïãú `status=UNCONFIRMED`, `value_text=NULL`
3. **snippet Í∑∏ÎåÄÎ°ú Ï†ÄÏû• Í∏àÏßÄ**

### 8.2 ÏàòÏ†ï Î∞©Ìñ•

**BEFORE** (ÌòÑÏû¨ ÏΩîÎìú):
```python
snippet = ev.get('snippet', '')
if 'ÎßåÏõê' in snippet or 'Ïõê' in snippet:
    value_text = snippet[:200]  # ‚ùå
    source_doc_type = ev.get('doc_type', '')
    break
```

**AFTER** (ÏàòÏ†ï Î∞©Ìñ•):
```python
snippet = ev.get('snippet', '')

# Ï†ïÍ∑úÏãùÏúºÎ°ú Í∏àÏï° Ï∂îÏ∂ú
amount_match = re.search(r'(\d{1,3}(,\d{3})*|\d+)\s*(ÎßåÏõê|Ïõê|Ï≤úÏõê)', snippet)

if amount_match:
    value_text = amount_match.group(0)  # ‚úÖ Í∏àÏï°Îßå Ï∂îÏ∂ú (Ïòà: "3000ÎßåÏõê")
    source_doc_type = ev.get('doc_type', '')
    break
else:
    # Ï∂îÏ∂ú Ïã§Ìå® ‚Üí UNCONFIRMED
    value_text = None
    source_doc_type = None
```

### 8.3 Ïû¨Ï†ÅÏû¨ Î≤îÏúÑ

**Ï†ÑÏ≤¥ Ïû¨Ï†ÅÏû¨ ÌïÑÏöî** (amount_fact ÌÖåÏù¥Î∏îÎßå):
```sql
TRUNCATE TABLE amount_fact CASCADE;
```

**Ïû¨Ïã§Ìñâ Î™ÖÎ†π**:
```bash
# ÏàòÏ†ï ÌõÑ Ïû¨Ïã§Ìñâ
python -m apps.loader.step9_loader --mode reset_then_load
```

---

## 9. DoD (Definition of Done)

ÏàòÏ†ï ÏôÑÎ£å Í∏∞Ï§Ä:

### 9.1 DB Í≤ÄÏ¶ù

```sql
-- 1. Í∏àÏßÄ Ìå®ÌÑ¥ 0Í±¥
SELECT COUNT(*)
FROM amount_fact
WHERE value_text ~* '(ÌäπÏïΩÍ¥Ä|Î™©Ï∞®|ÎØºÏõêÏÇ¨Î°Ä|ÏïàÎÇ¥|ÏòàÏãú)';
-- Expected: 0

-- 2. Ï†ïÏÉÅ Í∏àÏï° Ìå®ÌÑ¥ ÎπÑÏú®
SELECT
  COUNT(*) FILTER (WHERE value_text ~* '(\d{1,3}(,\d{3})*|\d+)\s*(Ïõê|ÎßåÏõê|Ï≤úÏõê)') as valid_count,
  COUNT(*) FILTER (WHERE value_text IS NOT NULL) as total_non_null,
  ROUND(100.0 * COUNT(*) FILTER (WHERE value_text ~* '(\d{1,3}(,\d{3})*|\d+)\s*(Ïõê|ÎßåÏõê|Ï≤úÏõê)') /
    NULLIF(COUNT(*) FILTER (WHERE value_text IS NOT NULL), 0), 2) as valid_pct
FROM amount_fact;
-- Expected: valid_pct > 90%

-- 3. value_text Í∏∏Ïù¥ MAX
SELECT MAX(LENGTH(value_text)) as max_len
FROM amount_fact;
-- Expected: < 50 (Í∏àÏï°ÏùÄ ÏßßÏùå)
```

### 9.2 API Í≤ÄÏ¶ù

```bash
# API ÏöîÏ≤≠ (ÌïúÌôîÏÉùÎ™Ö A4200_1)
curl -X POST http://localhost:8001/compare \
  -H "Content-Type: application/json" \
  -d '{
    "intent": "PRODUCT_SUMMARY",
    "insurers": ["HANWHA"],
    "products": [{"insurer": "HANWHA", "product_name": "ÌïúÌôî Î¨¥Î∞∞Îãπ Îã§Ïù¥Î†âÌä∏ Í±¥Í∞ïÎ≥¥Ìóò"}],
    "target_coverages": [{"coverage_code": "A4200_1"}]
  }'

# Expected:
# - value_text: "3000ÎßåÏõê" (ÎòêÎäî Ïú†ÏÇ¨Ìïú Í∏àÏï°)
# - value_text: "ÎØºÏõêÏÇ¨Î°Ä..." ‚ùå Í∏àÏßÄ
```

### 9.3 Regression ÌôïÏù∏

- ‚úÖ Í∏∞Ï°¥ CONFIRMED Í±¥Ïàò Ïú†ÏßÄ ÎòêÎäî Ï¶ùÍ∞Ä
- ‚úÖ evidence_ref Î≥ÄÍ≤Ω ÏóÜÏùå
- ‚úÖ coverage_instance Î≥ÄÍ≤Ω ÏóÜÏùå

---

## 10. Í≤∞Î°†

### 10.1 Audit Í≤∞Í≥º ÏöîÏïΩ

| Ìï≠Î™© | ÏÉÅÌÉú | Ï°∞Ïπò |
|------|------|------|
| coverage_instance | ‚úÖ Ï†ïÏÉÅ | Ï°∞Ïπò Î∂àÌïÑÏöî |
| evidence_ref | ‚úÖ Ï†ïÏÉÅ (Ïó≠ÏÇ¨Ï†Å Ìï©Ïùò Í∏∞Ï§Ä) | Ï°∞Ïπò Î∂àÌïÑÏöî |
| amount_fact | ‚ùå Ïã¨Í∞ÅÌïú Ïò§Ïóº (67.57% Í∏àÏßÄ Ìå®ÌÑ¥) | **Loader ÏàòÏ†ï ÌïÑÏàò** |

### 10.2 Case ÌåêÏ†ï

**‚úÖ Case 1 ÌôïÏ†ï**:
- amount_factÎßå Ïò§Ïóº
- evidence_refÎäî Ï†ïÏÉÅ (Î™©Ï∞®ÏÑ± snippetÏùÄ ÌóàÏö© Î≤îÏúÑ)
- coverage_instanceÎäî Ï†ïÏÉÅ

### 10.3 Next Step

**STEP NEXT-10-Œ≤2: Fix Plan + Rebuild Plan**

1. Loader ÏàòÏ†ï (`apps/loader/step9_loader.py`)
2. amount_fact Ïû¨Ï†ÅÏû¨
3. DoD Í≤ÄÏ¶ù
4. Audit Ïû¨Ïã§Ìñâ (Í≤ÄÏ¶ù)

---

**Î≥¥Í≥†ÏÑú Ï¢ÖÎ£å**
