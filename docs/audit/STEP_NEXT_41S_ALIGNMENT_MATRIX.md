# STEP NEXT-41S: Alignment Matrix (Phase A-4)

**Date**: 2025-12-31
**Purpose**: Map DB Schema â†” Loader Binding â†” SSOT Fields (3-way comparison)

**Legend**:
- âœ… **OK**: All 3 aligned (DB column exists, Loader writes it, SSOT provides data)
- âš ï¸ **MISMATCH**: Name/type/format differs
- âŒ **MISSING**: Column/field missing in one or more layers
- ğŸ”§ **GENERATED**: Loader-generated (not from SSOT)

---

## Table 1: coverage_canonical

**SSOT Source**: Excel (`ë‹´ë³´ëª…mappingìë£Œ.xlsx`) â€” **NOT coverage_cards.jsonl**

| DB Column | Type | Loader Writes | SSOT Field | Status | Notes |
|-----------|------|---------------|------------|--------|-------|
| `coverage_code` | text PK | âœ… Yes | Excel `cre_cvr_cd` | âœ… OK | Direct mapping |
| `coverage_name_canonical` | text NOT NULL | âœ… Yes | Excel `ì‹ ì •ì›ì½”ë“œëª…` | âœ… OK | Direct mapping |
| `coverage_category` | text NULL | âœ… Yes (NULL) | N/A | âœ… OK | Not from Excel, explicitly NULL |
| `payment_event` | text NULL | âœ… Yes (NULL) | N/A | âœ… OK | Not from Excel, explicitly NULL |
| `created_at` | timestamptz | âœ… Yes | N/A | âœ… OK | Generated by loader |
| `updated_at` | timestamptz | âœ… Yes (on conflict) | N/A | âœ… OK | Generated on upsert |

**Verdict**: âœ… **ALIGNED** (SSOT is Excel, not coverage_cards.jsonl)

---

## Table 2: coverage_instance

**SSOT Source**: CSV (`data/scope/{insurer}_scope_mapped.csv`)

| DB Column | Type | Loader Writes | SSOT Field | Status | Notes |
|-----------|------|---------------|------------|--------|-------|
| `instance_id` | uuid PK | âœ… Yes (DB default) | N/A | âœ… OK | DB-generated UUID |
| `insurer_id` | uuid FK | âœ… Yes | N/A | ğŸ”§ GENERATED | Lookup from `insurer_map[insurer_key]` |
| `product_id` | uuid FK | âœ… Yes | N/A | ğŸ”§ GENERATED | Derived `{insurer_key}_health_v1` |
| `variant_id` | uuid FK NULL | âœ… Yes (NULL) | N/A | âœ… OK | No variant in CSV |
| `coverage_code` | text FK NULL | âœ… Yes | CSV `coverage_code` | âœ… OK | NULL allowed for unmatched |
| `coverage_name_raw` | text NOT NULL | âœ… Yes | CSV `coverage_name_raw` | âœ… OK | Direct mapping |
| `source_page` | integer NULL | âœ… Yes | CSV `source_page` | âœ… OK | Convert to int or NULL |
| `mapping_status` | text NOT NULL | âœ… Yes | CSV `mapping_status` | âœ… OK | Validated âˆˆ {matched, unmatched} |
| `match_type` | text NULL | âœ… Yes | CSV `match_type` | âœ… OK | Convert emptyâ†’NULL |
| `created_at` | timestamptz | âœ… Yes | N/A | âœ… OK | Generated by loader |
| `instance_key` | text UNIQUE | âœ… Yes | N/A | ğŸ”§ GENERATED | Natural key (deterministic) |
| `updated_at` | timestamptz | âœ… Yes (on conflict) | N/A | âœ… OK | Generated on upsert |

**Verdict**: âœ… **ALIGNED** (SSOT is CSV, loader generates instance_key correctly)

---

## Table 3: evidence_ref

**SSOT Source (EXPECTED)**: `data/compare/{insurer}_coverage_cards.jsonl` (`evidences[]`)
**Loader Source (ACTUAL)**: `data/evidence_pack/{insurer}_evidence_pack.jsonl` (**DEPRECATED**)

| DB Column | Type | Loader Writes | SSOT Field (coverage_cards) | Loader Reads (evidence_pack) | Status | Notes |
|-----------|------|---------------|----------------------------|------------------------------|--------|-------|
| `evidence_id` | uuid PK | âœ… Yes (DB default) | N/A | N/A | âœ… OK | DB-generated UUID |
| `coverage_instance_id` | uuid FK | âœ… Yes | N/A | N/A | ğŸ”§ GENERATED | Lookup via `coverage_name_raw` |
| `document_id` | uuid FK | âœ… Yes | `evidences[].file_path` | `evidences[].file_path` | âš ï¸ MISMATCH | Path format mismatch (see below) |
| `doc_type` | text NOT NULL | âœ… Yes | `evidences[].doc_type` | `evidences[].doc_type` | âœ… OK | Direct mapping |
| `page` | integer NOT NULL | âœ… Yes | `evidences[].page` | `evidences[].page` | âœ… OK | Direct mapping |
| `snippet` | text NOT NULL | âœ… Yes | `evidences[].snippet` | `evidences[].snippet` | âœ… OK | Truncated to 500 chars |
| `match_keyword` | text NULL | âœ… Yes | `evidences[].match_keyword` | `evidences[].match_keyword` | âœ… OK | Direct mapping |
| `rank` | integer 1-3 | âœ… Yes | âŒ MISSING | âŒ MISSING | ğŸ”§ GENERATED | Loader generates `idx + 1` |
| `created_at` | timestamptz | âœ… Yes | N/A | N/A | âœ… OK | Generated by loader |
| `evidence_key` | text UNIQUE | âœ… Yes | N/A | N/A | ğŸ”§ GENERATED | Natural key (deterministic) |
| `updated_at` | timestamptz | âœ… Yes (on conflict) | N/A | N/A | âœ… OK | Generated on upsert |

### Critical Mismatch: evidence_ref Source

| Aspect | Expected (SSOT) | Actual (Loader) | Status |
|--------|----------------|-----------------|--------|
| **Source File** | `coverage_cards.jsonl` | `evidence_pack.jsonl` | âŒ **MISMATCH** |
| **SSOT Status** | Current (STEP 5 output) | DEPRECATED (CLAUDE.md line 41) | âŒ **MISMATCH** |
| **SSOT Has `rank`** | âŒ No | âŒ No | âœ… OK (loader generates) |

### Path Format Mismatch

| Layer | Path Format | Example |
|-------|-------------|---------|
| **SSOT** | Absolute | `/Users/cheollee/inca-rag-scope/data/evidence_text/kb/ì•½ê´€/KB_ì•½ê´€.page.jsonl` |
| **DB Schema** | Relative | `data/pdf/samsung/...` (per comment in schema) |
| **Loader** | Normalizes | Strips prefix â†’ `data/evidence_text/...` |

**Implication**: Loader path normalization (line 479-485) may fail if `document` table uses different base path (e.g., `data/pdf/` vs `data/evidence_text/`).

**Verdict**: âš ï¸ **DRIFT** (Source file mismatch + path format mismatch)

---

## Table 4: amount_fact

**SSOT Source (EXPECTED)**: `data/compare/{insurer}_coverage_cards.jsonl` (`amount` field)
**SSOT Reality**: **NO `amount` field exists** (confirmed Phase A-2)

| DB Column | Type | Loader Writes | SSOT Field | Status | Notes |
|-----------|------|---------------|------------|--------|-------|
| `amount_id` | uuid PK | âœ… Yes (DB default) | N/A | âœ… OK | DB-generated UUID |
| `coverage_instance_id` | uuid FK | âœ… Yes | N/A | ğŸ”§ GENERATED | Lookup via `coverage_name_raw` |
| `evidence_id` | uuid FK NULL | âœ… Yes | `amount.evidence_ref` | âŒ **MISSING** | SSOT has NO `amount` field |
| `status` | text NOT NULL | âœ… Yes | `amount.status` | âŒ **MISSING** | Defaults to `'UNCONFIRMED'` |
| `value_text` | text NULL | âœ… Yes | `amount.value_text` | âŒ **MISSING** | Defaults to NULL |
| `source_doc_type` | text NULL | âœ… Yes | `amount.source_doc_type` | âŒ **MISSING** | Defaults to NULL |
| `source_priority` | text NULL | âœ… Yes | `amount.source_priority` | âŒ **MISSING** | Defaults to NULL |
| `notes` | jsonb | âœ… Yes | N/A | âœ… OK | Always `[]` (empty) |
| `created_at` | timestamptz | âœ… Yes | N/A | âœ… OK | Generated by loader |
| `updated_at` | timestamptz | âœ… Yes (on conflict) | N/A | âœ… OK | Generated on upsert |

### Critical Finding: amount Field Missing

| Aspect | Expected | Reality | Status |
|--------|----------|---------|--------|
| **SSOT Has `amount`** | âœ… Yes (per loader code) | âŒ **NO** (confirmed Phase A-2) | âŒ **MISSING** |
| **Loader Fallback** | Write UNCONFIRMED (line 571-577) | âœ… Implemented | âš ï¸ **WORKS BUT WRONG** |
| **DB Has 285 Rows** | Should be UNCONFIRMED | Status unknown | ğŸ” **INVESTIGATE** |

**Implication**:
- If loader runs on current SSOT, ALL amount_fact rows will be `UNCONFIRMED` with NULL values.
- DB currently has 285 amount_fact rows â†’ **came from different source** (not current SSOT).
- Either:
  - (a) Amount data is in a **separate file** (e.g., `*_amounts.jsonl`), OR
  - (b) DB was loaded from **old SSOT** (before amount removal), OR
  - (c) Amount enrichment was done **directly to DB** (bypassing SSOT)

**Verdict**: âŒ **MISSING** (SSOT has no amount field, loader expects it)

---

## Cross-Table FK Alignment

| FK Relationship | DB Schema | Loader Binding | Status |
|-----------------|-----------|----------------|--------|
| `coverage_instance.coverage_code` â†’ `coverage_canonical.coverage_code` | âœ… FK with CASCADE | âœ… Lookup | âœ… OK |
| `coverage_instance.insurer_id` â†’ `insurer.insurer_id` | âœ… FK | âœ… Lookup | âœ… OK |
| `coverage_instance.product_id` â†’ `product.product_id` | âœ… FK | âœ… Lookup | âœ… OK |
| `evidence_ref.coverage_instance_id` â†’ `coverage_instance.instance_id` | âœ… FK | âœ… Lookup | âœ… OK |
| `evidence_ref.document_id` â†’ `document.document_id` | âœ… FK | âš ï¸ Lookup (may fail) | âš ï¸ MISMATCH |
| `amount_fact.coverage_instance_id` â†’ `coverage_instance.instance_id` | âœ… FK | âœ… Lookup | âœ… OK |
| `amount_fact.evidence_id` â†’ `evidence_ref.evidence_id` | âœ… FK (MANDATORY if CONFIRMED) | âš ï¸ Lookup or create | âš ï¸ CONDITIONAL |

---

## Summary: Critical Issues by Table

| Table | Overall Status | Critical Issues |
|-------|---------------|-----------------|
| `coverage_canonical` | âœ… **ALIGNED** | None |
| `coverage_instance` | âœ… **ALIGNED** | None |
| `evidence_ref` | âš ï¸ **DRIFT** | 1. Loader reads DEPRECATED `evidence_pack.jsonl` instead of SSOT<br>2. Path format mismatch (absolute vs relative) |
| `amount_fact` | âŒ **MISSING** | **SSOT has NO `amount` field** â€” loader will write UNCONFIRMED |

---

## Recommended Path Decision (Phase A-5 Input)

Based on alignment matrix:

### Path-2: âš ï¸ "Schema Drift" (RECOMMENDED)

**Justification**:
1. **DB Schema is GAMMA-patched** (instance_key, evidence_key, updated_at all present)
2. **No DDL changes needed** (schema matches loader expectations)
3. **Data drift exists**:
   - evidence_ref is loading from DEPRECATED source
   - amount_fact has stale data (285 rows, but SSOT has no amount)

**Required Actions**:
- **NO DDL** (schema is correct)
- **Phase B-1**: Update loader to read SSOT (`coverage_cards.jsonl`) instead of DEPRECATED `evidence_pack.jsonl`
- **Phase B-2**: Reset + reload data (TRUNCATE + loader run)
- **Phase B-3**: Verify amount_fact becomes UNCONFIRMED (expected behavior until amount enrichment re-runs)

### NOT Path-1 (Schema OK)

**Why NOT**: Data sources are misaligned (DEPRECATED file usage + missing amount).

### NOT Path-3 (Schema Rebuild)

**Why NOT**: Schema is correct (GAMMA-patched), no structural issues.

---

**Phase A-4 Complete**: Alignment matrix shows **Path-2 (Schema Drift)** is required.
