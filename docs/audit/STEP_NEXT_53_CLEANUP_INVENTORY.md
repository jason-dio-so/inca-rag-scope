# STEP NEXT-53 Cleanup Inventory

**Generated**: 2026-01-01
**Purpose**: Identify legacy outputs, pipelines, and documents to archive before SSOT enforcement

---

## 1. Executive Summary

**SSOT Constitutional Rule** (STEP NEXT-52-HK enforced):
- ALL Step2+ outputs MUST reside in `data/scope_v3/` ONLY
- NO Step2 may import Step1 modules
- Entrypoint: `manifest → Step1 → Step2-a → Step2-b` (fixed)

**Current Status**:
- ✅ `data/scope_v3/` contains canonical pipeline outputs (KEEP)
- ⚠️ `data/scope/` contains ~2266 lines of legacy Step1 outputs (ARCHIVE)
- ⚠️ `data/scope_v2/` contains ~148 lines of v2 Step1 outputs (ARCHIVE)
- ⚠️ `pipeline/step1_extract_scope/` and `pipeline/step1_sanitize_scope/` are legacy pipelines (ARCHIVE)

---

## 2. KEEP (Canonical Pipeline — DO NOT TOUCH)

### 2.1 SSOT Outputs (data/scope_v3/)
```
data/scope_v3/*_step1_raw_scope_v3.jsonl          # Step1 raw extraction
data/scope_v3/*_step2_sanitized_scope_v1.jsonl    # Step2-a sanitization
data/scope_v3/*_step2_canonical_scope_v1.jsonl    # Step2-b canonical mapping
data/scope_v3/*_step2_dropped.jsonl               # Step2-a audit trail
data/scope_v3/*_step2_mapping_report.jsonl        # Step2-b audit trail
data/scope_v3/LATEST                              # Run pointer
data/scope_v3/_RUNS/                              # Run metadata
```

**Count**: 64 JSONL files (8 insurers × 8 files each)

### 2.2 Canonical Pipeline Code
```
pipeline/step1_summary_first/
  ├── profile_builder_v3.py        # Manifest-driven profile builder
  ├── extractor_v3.py              # Manifest-driven extraction
  ├── pdf_fingerprint.py           # Fingerprint gate
  └── README.md

pipeline/step2_sanitize_scope/
  ├── run.py                       # JSONL-only sanitization
  └── sanitize.py

pipeline/step2_canonical_mapping/
  ├── run.py                       # JSONL-only mapping
  └── canonical_mapper.py
```

### 2.3 Core Assets
```
data/profile/*_proposal_profile_v3.json          # Profile SSOT
data/manifests/proposal_pdfs_v1.json             # Manifest SSOT
data/sources/mapping/담보명mapping자료.xlsx       # Canonical mapping INPUT
```

### 2.4 Documentation (KEEP)
```
CLAUDE.md                                        # Project constitution
data/scope_v3/README.md                          # SSOT README
docs/STEP_NEXT_49_OUTPUT_SSOT.md                 # SSOT design doc
docs/STEP_NEXT_50_DB_MAPPING_FIX.md              # Mapping design
docs/STEP_NEXT_52_ROOT_CAUSE_ANALYSIS.json       # RCA
STATUS.md                                        # Progress log
```

---

## 3. ARCHIVE — Legacy Outputs (Non-SSOT)

### 3.1 data/scope/ (Legacy Step1 outputs)
**Status**: Contains old Step1 extraction outputs (pre-v3)
**Action**: ARCHIVE to `archive/legacy_outputs/run_<UTC>_step_next_53/data_scope/`

**Files**:
```
data/scope/
  ├── *_step1_raw_scope.jsonl          # 8 files (legacy Step1 output)
  ├── *_scope_filtered_out.jsonl       # 8 files (legacy filter output)
  ├── *_scope.csv                      # 8 files (legacy CSV export)
  ├── *_scope_mapped.csv               # 8 files (legacy mapping output)
  ├── *_scope_mapped.sanitized.csv     # 3 files (legacy sanitize output)
  ├── *_filtered_out.jsonl             # 1 file (KB legacy)
  └── *_unmatched_review.csv           # 2 files (manual review artifacts)
```

**Total**: ~51 files, ~2266 lines

**Rationale**: These files were generated by `step1_extract_scope` (deprecated). Current canonical pipeline uses `step1_summary_first` → outputs to `scope_v3/`.

### 3.2 data/scope_v2/ (v2 Step1 outputs)
**Status**: Contains Step1 v2 extraction outputs
**Action**: ARCHIVE to `archive/legacy_outputs/run_<UTC>_step_next_53/data_scope_v2/`

**Files**:
```
data/scope_v2/
  └── *_step1_raw_scope_v2.jsonl       # 7 files (v2 extraction)
```

**Total**: 7 files, ~148 lines

**Rationale**: v2 extraction replaced by v3 (manifest-driven + fingerprint gate). No longer used.

### 3.3 Existing Archive (Already Moved)
```
archive/scope_legacy/run_20260101_step_next_52_hk/
  └── (legacy Step2 outputs from data/scope/, moved in STEP NEXT-52-HK)

archive/scope_v2_legacy/
  └── (unknown legacy contents)

archive/scope_v1_legacy/
  └── (unknown legacy contents)
```

**Action**: KEEP as-is (already archived).

---

## 4. ARCHIVE — Legacy Pipelines (Non-Canonical)

### 4.1 pipeline/step1_extract_scope/
**Status**: Legacy Step1 extraction pipeline (pre-summary-first)
**Action**: ARCHIVE to `archive/legacy_pipelines/run_<UTC>_step_next_53/step1_extract_scope/`

**Files**:
```
pipeline/step1_extract_scope/
  ├── proposal_fact_extractor_v2.py
  ├── proposal_fact_extractor.py
  ├── run.py
  └── hardening.py
```

**Rationale**: Replaced by `step1_summary_first` (v3). No longer part of canonical pipeline.

### 4.2 pipeline/step1_sanitize_scope/
**Status**: Legacy Step1 sanitization pipeline (now Step2-a)
**Action**: ARCHIVE to `archive/legacy_pipelines/run_<UTC>_step_next_53/step1_sanitize_scope/`

**Files**:
```
pipeline/step1_sanitize_scope/
  ├── run.py
  └── __init__.py
```

**Rationale**: Sanitization moved to Step2-a (`pipeline/step2_sanitize_scope/`). Old Step1 sanitize is obsolete.

---

## 5. KEEP — Downstream Pipelines

**Note**: These are NOT part of Step1→Step2 core, but are still active downstream:

```
pipeline/step3_extract_text/          # Evidence extraction (active)
pipeline/step4_evidence_search/       # Evidence search (active)
pipeline/step5_build_cards/           # Coverage cards SSOT (active)
pipeline/step7_amount_extraction/     # Amount enrichment (active)
```

**Action**: NO CHANGE (these consume scope_v3 outputs).

---

## 6. DELETE Candidates (Minimal)

**Principle**: Prefer ARCHIVE over DELETE.

### 6.1 Temporary/Debug Files
```
pipeline/step1_summary_first/debug_*.py          # 3 debug scripts
pipeline/step1_summary_first/verify_kb_*.py      # 2 KB-specific verification scripts
```

**Action**: KEEP for now (may be useful for debugging). Re-evaluate in future cleanup.

### 6.2 __pycache__ Directories
```
pipeline/*/__pycache__/
```

**Action**: DELETE (auto-generated, safe to remove).

---

## 7. Documentation Review

### 7.1 Docs to Update
- **CLAUDE.md**: Ensure entrypoint section reflects ONLY canonical pipeline
- **data/scope_v3/README.md**: Add "DO NOT USE data/scope/" warning
- **data/scope/README.md**: CREATE with "ARCHIVED — Use scope_v3/" warning

### 7.2 Docs to Keep As-Is
```
docs/STEP_NEXT_*.md                   # Historical design docs (KEEP)
docs/audit/*.md                       # Audit reports (KEEP)
STATUS.md                             # Progress log (UPDATE)
```

---

## 8. Gate Violations (Current State)

### GATE-53-1: SSOT Violation
**Status**: ✅ PASS
**Check**: No Step2 outputs exist in `data/scope/`
**Evidence**: Legacy `data/scope/` contains only Step1 outputs (no `*_step2_*.jsonl`)

### GATE-53-2: Step2 Independence
**Status**: ✅ PASS
**Check**: Step2 modules do NOT import Step1 modules
**Evidence**: `grep` scan found no Step1 imports in `pipeline/step2_*/`

### GATE-53-3: Entrypoint Documentation
**Status**: ⚠️ PARTIAL
**Check**: CLAUDE.md contains canonical entrypoint, but `data/scope_v3/README.md` may need update
**Action**: Finalize both docs

### GATE-53-4: Smoke Reproducibility
**Status**: ⏳ PENDING
**Action**: Run after archiving complete

---

## 9. Archive Plan Summary

### Phase 1: Legacy Outputs
```bash
# Create archive directory
mkdir -p archive/legacy_outputs/run_$(date -u +%Y%m%d_%H%M%S)_step_next_53/

# Move data/scope/ (except README if exists)
mv data/scope archive/legacy_outputs/run_*/data_scope/

# Move data/scope_v2/
mv data/scope_v2 archive/legacy_outputs/run_*/data_scope_v2/
```

### Phase 2: Legacy Pipelines
```bash
# Create pipeline archive
mkdir -p archive/legacy_pipelines/run_$(date -u +%Y%m%d_%H%M%S)_step_next_53/

# Move step1_extract_scope
mv pipeline/step1_extract_scope archive/legacy_pipelines/run_*/

# Move step1_sanitize_scope
mv pipeline/step1_sanitize_scope archive/legacy_pipelines/run_*/
```

### Phase 3: Warning READMEs
```bash
# Create warning in data/scope/
echo "ARCHIVED — Use data/scope_v3/" > data/scope/README.md

# Create warning in pipeline/step1_extract_scope/
echo "ARCHIVED — Use step1_summary_first" > pipeline/step1_extract_scope/README.md
```

---

## 10. Expected Final State

**After archiving**:
```
data/
  ├── scope/                      # Empty except README warning
  ├── scope_v2/                   # REMOVED (archived)
  └── scope_v3/                   # SSOT (64 JSONL files)

pipeline/
  ├── step1_extract_scope/        # REMOVED (archived)
  ├── step1_sanitize_scope/       # REMOVED (archived)
  ├── step1_summary_first/        # CANONICAL (v3)
  ├── step2_sanitize_scope/       # CANONICAL (Step2-a)
  ├── step2_canonical_mapping/    # CANONICAL (Step2-b)
  ├── step3_extract_text/         # ACTIVE downstream
  ├── step4_evidence_search/      # ACTIVE downstream
  ├── step5_build_cards/          # ACTIVE downstream
  └── step7_amount_extraction/    # ACTIVE downstream

archive/
  ├── legacy_outputs/run_<UTC>_step_next_53/
  │   ├── data_scope/             # 51 files, ~2266 lines
  │   └── data_scope_v2/          # 7 files, ~148 lines
  └── legacy_pipelines/run_<UTC>_step_next_53/
      ├── step1_extract_scope/    # 4 Python modules
      └── step1_sanitize_scope/   # 2 Python modules
```

---

## 11. Risks & Mitigations

**Risk 1**: Accidentally delete active files
**Mitigation**: Use `mv` (not `rm`), archive to timestamped directory with full path preservation

**Risk 2**: Downstream code still references legacy paths
**Mitigation**: Run full test suite after archiving (`pytest -q`)

**Risk 3**: Manual workflows depend on `data/scope/` outputs
**Mitigation**: Create README warning, verify with team before archiving

---

## 12. Execution Checklist

- [ ] Review this inventory with team
- [ ] Create timestamped archive directories
- [ ] Move `data/scope/` → archive
- [ ] Move `data/scope_v2/` → archive
- [ ] Move `pipeline/step1_extract_scope/` → archive
- [ ] Move `pipeline/step1_sanitize_scope/` → archive
- [ ] Create warning READMEs at original locations
- [ ] Run `pytest -q` (verify no regressions)
- [ ] Run smoke test (Step1→Step2 for 1 insurer)
- [ ] Update CLAUDE.md runbook
- [ ] Update data/scope_v3/README.md
- [ ] Update STATUS.md
- [ ] Commit: `chore(step-next-53): archive legacy outputs/pipelines`
- [ ] Commit: `test(step-next-53): add GATE-53 guardrails`
- [ ] Commit: `docs(step-next-53): finalize runbook`

---

**END OF INVENTORY**
