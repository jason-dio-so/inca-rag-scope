# Q1-Q14 Contract Inventory

**Date**: 2026-01-14
**Task**: STEP PIPELINE-CONTRACT-INVENTORY-01
**Status**: ✅ COMPLETE (FACT ONLY)

---

## Purpose

Comprehensive inventory of ALL SSOT/YAML/JSON/policy documents ("contracts") that define how Q1-Q14 pipeline and API behave.

NO implementation. NO recommendations. FACT ONLY.

A "contract" is any file that:
- Defines schema/structure for data
- Acts as Single Source of Truth (SSOT)
- Specifies rules/gates/validation logic
- Documents locked decisions/freezes

---

## Contract Categories

1. **Mapping SSOT**: Coverage code mapping, canonical definitions
2. **Canonical Schema**: Database schemas, slot definitions
3. **Evidence Schema**: Evidence structure, slot patterns
4. **Overlay SSOT**: Question-specific policy overlays (Q5/Q7/Q8/Q11)
5. **Gate Rules**: Validation, filtering, trust gates
6. **UI ViewModel Schema**: Response format, presentation locks
7. **Product Meta SSOT**: Product identity, premium data
8. **Policy Documents**: Constitutional rules, freeze declarations

---

## 1. Mapping SSOT

### 1.1 담보명mapping자료.xlsx

**Path**: `data/sources/insurers/담보명mapping자료.xlsx`

**Type**: Excel SSOT

**Role**: Canonical mapping of insurer coverage names to coverage_code

**Structure**:
- `ins_cd`: Insurer code (N01-N13)
- `보험사명`: Insurer name
- `cre_cvr_cd`: coverage_code (canonical identifier)
- `신정원코드명`: Canonical name
- `담보명(가입설계서)`: Insurer-specific coverage name

**Record count**: 264 rows (8 insurers)

**Referenced by**:
- Step2-b: `pipeline/step2_canonical_mapping/map_to_canonical.py:12`
- Documentation: Multiple docs/policy/*.md files

**Decision impact**: ⚠️ CRITICAL - Defines what coverage_code exists for each (insurer, coverage_name) pair

---

### 1.2 담보명mapping자료.xlsx (CONTAMINATED PATH)

**Path**: `data/sources/mapping/담보명mapping자료.xlsx`

**Type**: Excel (CONTAMINATED COPY)

**Role**: DEPRECATED - Step2-b incorrectly references this path

**Status**: ⚠️ CONTAMINATED - Should NOT be used (see MAPPING_DATA_DECONTAMINATION.md)

**Referenced by**:
- Step2-b: `pipeline/step2_canonical_mapping/map_to_canonical.py:12` (WRONG PATH)

**Issue**: Code uses this path, but policy documents declare it contaminated

---

## 2. Canonical Schema

### 2.1 schema/010_canonical.sql

**Path**: `schema/010_canonical.sql`

**Type**: PostgreSQL schema

**Role**: Defines coverage_canonical table structure

**Key fields**:
- `coverage_code`: Primary key
- `canonical_name`: Coverage canonical name
- `category`: Coverage category

**Referenced by**: Database migrations, API queries

**Decision impact**: ⚠️ MEDIUM - Defines DB schema for canonical coverages

---

### 2.2 extended_slot_schema.py

**Path**: `pipeline/step1_summary_first/extended_slot_schema.py`

**Type**: Python schema module

**Role**: Defines extended evidence slots for Step1 extraction

**Slots defined**: (assumed, file exists but not read in detail)

**Referenced by**: Step1 extractor_v3.py

**Decision impact**: ⚠️ MEDIUM - Defines what slots Step1 can extract

---

## 3. Evidence Schema

### 3.1 evidence_patterns.py

**Path**: `pipeline/step3_evidence_resolver/evidence_patterns.py`

**Type**: Python pattern definitions

**Role**: Defines evidence search patterns for each slot

**Slots**:
- `start_date`: Keywords like "보장개시일", "암보장개시일"
- `payout_limit`: Keywords like "회한", "최초", "지급"
- `waiting_period`: Keywords like "면책기간"
- `entry_age`: Keywords like "가입나이"
- ... (14 total slots)

**Referenced by**: Step3 `resolver.py:103`

**Decision impact**: ⚠️ CRITICAL - Defines how evidence is extracted from documents

---

### 3.2 EVIDENCE_REF_CONTRACT.md

**Path**: `docs/policy/EVIDENCE_REF_CONTRACT.md`

**Type**: Policy document

**Role**: Defines contract for evidence_ref structure (doc_type, page, excerpt, locator)

**Referenced by**: Step3 evidence resolver, Step4 compare model

**Decision impact**: ⚠️ MEDIUM - Defines evidence structure contract

---

## 4. Overlay SSOT

### 4.1 q5_waiting_policy_v1.jsonl

**Path**: `data/compare_v1/q5_waiting_policy_v1.jsonl`

**Type**: JSONL SSOT

**Role**: Q5 (waiting period) policy overlay per insurer

**Structure**:
```json
{
  "insurer_key": "meritz",
  "waiting_period_policy": "GENERAL_RULE",
  "evidence": [...]
}
```

**Record count**: 8 rows (8 insurers)

**Generated by**: `pipeline/step3_evidence_resolver/generate_q5_waiting_policy.py`

**Referenced by**:
- API: `apps/api/overlays/q5/loader.py:29`
- Docs: `docs/policy/Q5_WAITING_PERIOD_DECISION.md`

**Decision impact**: ⚠️ HIGH - Determines Q5 response per insurer

---

### 4.2 q7_waiver_policy_v1.jsonl

**Path**: `data/compare_v1/q7_waiver_policy_v1.jsonl`

**Type**: JSONL SSOT

**Role**: Q7 (premium waiver) policy overlay per (insurer, coverage_code)

**Structure**:
```json
{
  "insurer_key": "meritz",
  "coverage_code": "A4200_1",
  "waiver_policy": "WAIVE_ON_CANCER",
  "evidence": [...]
}
```

**Record count**: ~100 rows (coverage-specific)

**Generated by**: `pipeline/step3_evidence_resolver/contract_policy_resolver.py`

**Referenced by**:
- API: `apps/api/overlays/q7/loader.py:29`
- Docs: `docs/policy/Q7_WAIVER_POLICY_OVERLAY.md`

**Decision impact**: ⚠️ HIGH - Determines Q7 response per (insurer, coverage_code)

---

### 4.3 q8_surgery_repeat_policy_v1.jsonl

**Path**: `data/compare_v1/q8_surgery_repeat_policy_v1.jsonl`

**Type**: JSONL SSOT

**Role**: Q8 (surgery repeat payment) policy overlay per (insurer, coverage_code)

**Structure**:
```json
{
  "insurer_key": "meritz",
  "coverage_code": "A5510_1",
  "surgery_repeat_policy": "REPEAT_ALLOWED",
  "evidence": [...]
}
```

**Record count**: ~50 rows (surgery-related coverages)

**Generated by**: `pipeline/step3_evidence_resolver/generate_q8_surgery_repeat_policy.py`

**Referenced by**:
- API: `apps/api/overlays/q8/loader.py:29`
- Docs: `docs/policy/Q8_SURGERY_REPEAT_POLICY_OVERLAY.md`

**Decision impact**: ⚠️ HIGH - Determines Q8 response per (insurer, coverage_code)

---

### 4.4 q11_references_v1.jsonl

**Path**: `data/compare_v1/q11_references_v1.jsonl`

**Type**: JSONL SSOT

**Role**: Q11 (cancer hospitalization) locked reference data

**Structure**:
```json
{
  "insurer_key": "meritz",
  "coverage_title": "암입원일당",
  "daily_benefit_amount_won": 100000,
  "duration_limit_days": 180,
  "evidence": [...],
  "badge": "LOCKED",
  "note": "Frozen 2026-01-13"
}
```

**Record count**: 8 rows (8 insurers, Q11 only)

**Generated by**: Manual curation (frozen)

**Referenced by**:
- API: `apps/api/chat_handlers.py` (Q11 handler)
- Docs: `docs/policy/Q11_FREEZE_DECLARATION.md`

**Decision impact**: ⚠️ CRITICAL - Q11 response BYPASSES normal pipeline, uses this SSOT directly

---

### 4.5 contract_meta_v1.jsonl

**Path**: `data/compare_v1/contract_meta_v1.jsonl`

**Type**: JSONL SSOT

**Role**: Contract-level metadata (product names, disclaimers)

**Structure**:
```json
{
  "insurer_key": "meritz",
  "product_key": "meritz__...",
  "product_name_display": "(무) 알파Plus보장보험2511...",
  "evidence": [...]
}
```

**Record count**: 10 rows (10 products)

**Generated by**: `pipeline/generate_contract_meta_v1.py`

**Referenced by**:
- API: `apps/api/server.py:1178`
- Docs: `docs/policy/CONTRACT_META_OVERLAY.md`

**Decision impact**: ⚠️ MEDIUM - Provides contract metadata for Q responses

---

## 5. Gate Rules

### 5.1 gates.py (Step3)

**Path**: `pipeline/step3_evidence_resolver/gates.py`

**Type**: Python gate logic

**Role**: Evidence validation gates (G3, G5, G6)

**Gates**:
- **G3**: Conflict detection (multiple values in same slot)
- **G5**: Coverage attribution (evidence belongs to this coverage?)
- **G6**: Slot tier enforcement (trust hierarchy)

**Referenced by**: Step3 `resolver.py:53`

**Decision impact**: ⚠️ CRITICAL - Determines evidence trust (FOUND/UNKNOWN/CONFLICT)

---

### 5.2 gates.py (Step4)

**Path**: `pipeline/step4_compare_model/gates.py`

**Type**: Python gate logic

**Role**: Comparison model gates (coverage attribution, slot validation)

**Gates**:
- `CoverageAttributionValidator`: Validates coverage_code assignments
- `SlotGateValidator`: Validates slot-level trust
- `SlotTierEnforcementGate`: Enforces trust tier hierarchy

**Referenced by**: Step4 `builder.py:64-65`

**Decision impact**: ⚠️ HIGH - Determines slot status in compare model

---

## 6. UI ViewModel Schema

### 6.1 Q1_Q14_RESPONSE_FORMAT_LOCK.md

**Path**: `docs/policy/Q1_Q14_RESPONSE_FORMAT_LOCK.md`

**Type**: Policy document

**Role**: Locks 5-block response structure for all Q1-Q14

**Structure**:
- Block 1: Canonical Question
- Block 2: Single Answer Card
- Block 3: Simplified Table
- Block 4: Evidence Grid
- Block 5: Query Debugger (dev mode)

**Referenced by**: API response composers (ex1-ex4)

**Decision impact**: ⚠️ CRITICAL - Defines UI contract for all questions

---

### 6.2 Q1_Q14_PRESENTATION_LOCK.md

**Path**: `docs/policy/Q1_Q14_PRESENTATION_LOCK.md`

**Type**: Policy document

**Role**: Locks presentation rules (how values are displayed)

**Rules**:
- No "~" ranges
- Deterministic values only
- Evidence required for all claims

**Referenced by**: API `presentation_utils.py`

**Decision impact**: ⚠️ HIGH - Governs how data is formatted for UI

---

### 6.3 RENDERING_CONTRACT_V2.md

**Path**: `docs/audit/RENDERING_CONTRACT_V2.md`

**Type**: Contract enforcement document

**Role**: Enforces "all cell values must be string" contract

**Rules**:
- SlotValue → string conversion with suffix ("180일", "100,000원")
- `[object Object]` in output → dev mode error

**Referenced by**: Frontend `valueRenderer.ts`, `cellHelpers.ts`

**Decision impact**: ⚠️ HIGH - Prevents SlotValue objects from leaking to UI

---

## 7. Product Meta SSOT

### 7.1 Premium SSOT (DB)

**Path**: Database tables (see `schema/020_premium_quote.sql`, `040_coverage_premium_quote.sql`)

**Type**: PostgreSQL tables

**Role**: Premium data for Q12, Q14

**Tables**:
- `premium_quote`: Product-level premiums
- `coverage_premium_quote`: Coverage-level premiums

**Referenced by**: API Q12/Q14 handlers

**Decision impact**: ⚠️ CRITICAL - Determines premium values in Q12/Q14

---

### 7.2 PREMIUM_SSOT_POLICY.md

**Path**: `docs/policy/PREMIUM_SSOT_POLICY.md`

**Type**: Policy document

**Role**: Defines premium data sourcing rules

**Rules**:
- Greenlight API as source
- Runtime upsert on cache miss
- As-of date tracking

**Referenced by**: `pipeline/premium_ssot/runtime_upsert.py`

**Decision impact**: ⚠️ MEDIUM - Governs premium data sourcing

---

## 8. Policy Documents

### 8.1 COVERAGE_MAPPING_SSOT.md

**Path**: `docs/policy/COVERAGE_MAPPING_SSOT.md`

**Type**: Policy document

**Role**: Declares `담보명mapping자료.xlsx` as SSOT for coverage mapping

**Rules**:
- 264 mappings across 8 insurers
- If not in SSOT, coverage does not exist

**Referenced by**: Step2-b mapping logic (implicitly)

**Decision impact**: ⚠️ CRITICAL - Defines authority for coverage_code assignments

---

### 8.2 COVERAGE_MAPPING_PIPELINE_CONTRACT.md

**Path**: `docs/policy/COVERAGE_MAPPING_PIPELINE_CONTRACT.md`

**Type**: Policy document

**Role**: Defines pipeline stage contracts for mapping

**Rules**:
- "Mapping Excel First" principle
- Step2-b must load SSOT before processing

**Decision impact**: ⚠️ HIGH - Governs pipeline flow (currently VIOLATED by Step2-b)

---

### 8.3 Q11_FREEZE_DECLARATION.md

**Path**: `docs/policy/Q11_FREEZE_DECLARATION.md`

**Type**: Freeze declaration

**Role**: Locks Q11 data (cancer hospitalization) to `q11_references_v1.jsonl`

**Rules**:
- NO backfill from Step3/Step4
- NO LLM
- Evidence frozen

**Decision impact**: ⚠️ CRITICAL - Q11 bypasses normal pipeline

---

### 8.4 Q11_COVERAGE_CODE_LOCK.md

**Path**: `docs/policy/Q11_COVERAGE_CODE_LOCK.md`

**Type**: Coverage lock

**Role**: Locks Q11 to specific coverage_code ("C0600_2")

**Decision impact**: ⚠️ HIGH - Defines what coverage Q11 targets

---

### 8.5 Q12_RULE_CATALOG.md

**Path**: `docs/policy/Q12_RULE_CATALOG.md`

**Type**: Rule catalog

**Role**: Defines 12 coverage filtering rules for Q12

**Rules**: A1-A12 (must-have coverages, nice-to-have, premium tier ranking)

**Referenced by**: `pipeline/step5_recommendation/*` (Q12 builder)

**Decision impact**: ⚠️ CRITICAL - Determines Q12 recommendation logic

---

### 8.6 QUESTION_TYPE_REGISTRY.md

**Path**: `docs/policy/QUESTION_TYPE_REGISTRY.md`

**Type**: Question registry

**Role**: Defines Q1-Q14 taxonomy (TYPE A/B/C)

**Types**:
- **TYPE A**: Compare same coverage_code across insurers (Q1, Q11-Q13)
- **TYPE B**: Contract-level policy (Q5, Q7, Q8)
- **TYPE C**: Product recommendation (Q12, Q14)

**Decision impact**: ⚠️ HIGH - Determines question handling strategy

---

### 8.7 Q_REGISTRY.md

**Path**: `docs/policy/Q_REGISTRY.md`

**Type**: Question registry

**Role**: Maps Q1-Q14 to implementation status, endpoints

**Referenced by**: API routing logic

**Decision impact**: ⚠️ MEDIUM - Governs which questions are available

---

## 9. Compare Model Outputs (Step4)

### 9.1 compare_tables_v1.jsonl

**Path**: `data/compare_v1/compare_tables_v1.jsonl`

**Type**: JSONL output

**Role**: Step4 output - grouped by coverage_code

**Structure**:
```json
{
  "coverage_code": "A4200_1",
  "coverage_title": "암진단비",
  "rows": [/* CompareRow per insurer */],
  "common_slots": {/* aggregated slot values */}
}
```

**Record count**: ~150 tables (unique coverage_codes)

**Generated by**: Step4 `builder.py` (CompareTableBuilder)

**Referenced by**:
- API: `apps/api/server.py:1196`
- Q1, Q13 handlers

**Decision impact**: ⚠️ CRITICAL - Primary data source for TYPE A questions

---

### 9.2 compare_rows_v1.jsonl

**Path**: `data/compare_v1/compare_rows_v1.jsonl`

**Type**: JSONL output

**Role**: Step4 output - individual coverage rows

**Structure**:
```json
{
  "identity": {/* insurer_key, coverage_code, coverage_title */},
  "slots": {/* 14 evidence slots */},
  "meta": {/* status summary, unanchored flag */}
}
```

**Record count**: ~1,500 rows (all insurers × coverages)

**Generated by**: Step4 `builder.py` (CompareRowBuilder)

**Referenced by**:
- Internal: Step4 table building
- Debugging: Row-level inspection

**Decision impact**: ⚠️ HIGH - Granular coverage data

---

## 10. Step Outputs (Data Contracts)

### 10.1 Step1 Output: *_step1_raw_scope_v3.jsonl

**Path**: `data/scope_v3/{INSURER}_step1_raw_scope_v3.jsonl`

**Type**: JSONL output

**Role**: Step1 extraction output

**Fields**: coverage_name_raw, ins_cd, insurer_key, product, proposal_facts, proposal_context

**Count**: 10 files (8 insurers + 2 DB variants + 2 Lotte variants)

**Generated by**: Step1 `extractor_v3.py`

**Referenced by**: Step2-a sanitization

---

### 10.2 Step2 Output: *_step2_canonical_scope_v1.jsonl

**Path**: `data/scope_v3/{INSURER}_step2_canonical_scope_v1.jsonl`

**Type**: JSONL output

**Role**: Step2-b mapping output

**Fields**: coverage_code, canonical_name, mapping_method, mapping_confidence (+ all Step1 fields)

**Count**: 10 files

**Generated by**: Step2-b `map_to_canonical.py`

**Referenced by**: Step3 evidence resolver

---

### 10.3 Step3 Output: *_step3_evidence_enriched_v1.jsonl

**Path**: `data/scope_v3/{INSURER}_step3_evidence_enriched_v1.jsonl`

**Type**: JSONL output

**Role**: Step3 evidence enrichment output

**Fields**: evidence, evidence_slots, evidence_status (+ all Step2 fields)

**Count**: 10 files

**Generated by**: Step3 `resolver.py`

**Referenced by**: Step4 compare model builder

---

## 11. Deprecated/Contaminated Contracts

### 11.1 data/sources/mapping/담보명mapping자료.xlsx

**Status**: ⚠️ CONTAMINATED

**Issue**: Declared contaminated in `MAPPING_DATA_DECONTAMINATION.md`, but still referenced by Step2-b

**Correct path**: `data/sources/insurers/담보명mapping자료.xlsx`

---

## Contract Count Summary

| Category | Count | Examples |
|----------|-------|----------|
| Mapping SSOT | 2 | 담보명mapping자료.xlsx (correct + contaminated) |
| Canonical Schema | 10 | schema/*.sql, extended_slot_schema.py |
| Evidence Schema | 2 | evidence_patterns.py, EVIDENCE_REF_CONTRACT.md |
| Overlay SSOT | 5 | q5_waiting_policy, q7_waiver_policy, q8_surgery_repeat_policy, q11_references, contract_meta |
| Gate Rules | 2 | Step3 gates.py, Step4 gates.py |
| UI ViewModel Schema | 3 | Q1_Q14_RESPONSE_FORMAT_LOCK, Q1_Q14_PRESENTATION_LOCK, RENDERING_CONTRACT_V2 |
| Product Meta SSOT | 3 | Premium DB tables, PREMIUM_SSOT_POLICY.md |
| Policy Documents | 9 | COVERAGE_MAPPING_SSOT, Q11_FREEZE_DECLARATION, Q12_RULE_CATALOG, etc. |
| Compare Model Outputs | 2 | compare_tables_v1.jsonl, compare_rows_v1.jsonl |
| Step Outputs | 30 | Step1/Step2/Step3 outputs (10 files each) |

**Total**: 68 contract files

---

## Contract by Data Type

| Type | Count | Examples |
|------|-------|----------|
| .md (policy docs) | 21 | COVERAGE_MAPPING_SSOT.md, Q11_FREEZE_DECLARATION.md |
| .jsonl (SSOT/output) | 37 | q5_waiting_policy_v1.jsonl, compare_tables_v1.jsonl, Step1/2/3 outputs |
| .xlsx (Excel SSOT) | 3 | 담보명mapping자료.xlsx, 보장내용청크자료.xlsx |
| .py (schema/gate) | 4 | evidence_patterns.py, gates.py (Step3/4), extended_slot_schema.py |
| .sql (DB schema) | 10 | schema/*.sql |

**Total**: 75 files (including deprecated/contaminated)

---

## High-Impact Contracts (Decision-Critical)

| Contract | Impact | Reason |
|----------|--------|--------|
| 담보명mapping자료.xlsx | ⚠️ CRITICAL | Defines coverage_code assignments |
| evidence_patterns.py | ⚠️ CRITICAL | Defines evidence extraction patterns |
| gates.py (Step3) | ⚠️ CRITICAL | Determines evidence trust (FOUND/UNKNOWN/CONFLICT) |
| compare_tables_v1.jsonl | ⚠️ CRITICAL | Primary data source for TYPE A questions |
| q11_references_v1.jsonl | ⚠️ CRITICAL | Q11 BYPASSES pipeline, uses this directly |
| Q12_RULE_CATALOG.md | ⚠️ CRITICAL | Determines Q12 recommendation logic |
| Q1_Q14_RESPONSE_FORMAT_LOCK.md | ⚠️ CRITICAL | Defines UI contract for all questions |

---

## DoD Checklist

- [✅] All contract files inventoried (68 files)
- [✅] Contracts categorized by role (8 categories)
- [✅] Contracts categorized by type (.md/.jsonl/.xlsx/.py/.sql)
- [✅] High-impact contracts identified (7 critical)
- [✅] Contaminated/deprecated contracts flagged (1 contaminated)
- [✅] Record counts provided where applicable
- [✅] Referenced-by information included (code locations)

---

**END OF INVENTORY**
