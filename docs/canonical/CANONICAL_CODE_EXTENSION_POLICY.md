# Canonical Code Extension Policy (신정원 통일코드 확장 규칙)

**Effective Date**: 2025-12-31
**Authority**: Constitutional-level policy (supersedes all operational documents)
**Scope**: All canonical coverage code (cre_cvr_cd) extensions in `data/sources/mapping/담보명mapping자료.xlsx`

---

## 1. 정의 (Definitions)

### 1.1 cre_cvr_cd (Canonical Coverage Code)
- **Location**: Column `cre_cvr_cd` in `data/sources/mapping/담보명mapping자료.xlsx`
- **Purpose**: Unique identifier for canonical coverage definitions (신정원 통일코드)
- **Format**: `A{category}{event}_{suffix}` (e.g., A4200_1, A5200_2)
- **Immutability**: Once assigned to a coverage, MUST NOT be changed (only deprecated)

### 1.2 SSOT vs INPUT Contract Distinction

**INPUT Contract** (`담보명mapping자료.xlsx`):
- Source of canonical definitions
- Manually editable (CLAUDE.md:10)
- Contains mapping rules: coverage_name_raw → coverage_code
- **NOT the single source of truth** (CLAUDE.md:11)

**SSOT** (`data/compare/*_coverage_cards.jsonl`):
- Final locked state of all coverages
- Contains: coverage_code, mapping_status, evidence_status
- Generated by pipeline (Step5)
- **READ-ONLY** after generation

**Relationship**:
```
INPUT (mapping Excel) → Step2 mapping → SSOT (coverage_cards)
         ↑ Manual edit allowed      ↑ Pipeline generates, NO manual edit
```

### 1.3 Alias vs Extension

**Alias** (NOT an extension):
- New row in Excel with existing `coverage_code`
- Different `담보명(가입설계서)` pointing to same canonical
- Example: `(20년갱신)갱신형...` → `A4999_1` (canonical: `갱신형...`)

**Extension** (NEW code):
- New `coverage_code` value created
- New canonical coverage definition
- Example: `A4200_1` → `A4200_2` (new diagnosis variant)

---

## 2. 확장이 필요한 경우 (WHEN Extension Is Needed)

### 2.1 Alias Cannot Solve

Extension is needed ONLY when ALL of the following are true:

1. **Evidence exists** (`evidence_status: found` in coverage_cards)
2. **No existing canonical matches** (`mapping_status: unmatched` in scope_mapped.csv)
3. **Coverage is in proposal scope** (extracted by Step1, not filtered by Step1b)
4. **Distinct payment event or condition** (cannot be aliased to existing canonical)

### 2.2 Unmatched + Found Cases

**Operational Signal**:
```
coverage_name_raw: "갱신형 중증질환자(뇌혈관질환) 산정특례대상 진단비(연간1회한)"
mapping_status: unmatched
evidence_status: found
hits_by_doc_type: {약관: 3, 사업방법서: 0, 상품요약서: 1}
```

**Decision Tree**:
1. Can this be aliased to existing canonical? → YES: Add alias row, NO extension
2. Is payment trigger identical to existing code? → YES: Add alias row, NO extension
3. Is payment structure different (amount/frequency/conditions)? → YES: Extension MAY be allowed
4. Does it fit within existing prefix range? → NO: Extension DENIED

---

## 3. 확장이 허용되는 조건 (IF Extension Is Allowed)

### 3.1 Prefix Range Rules

**Category Prefixes** (FIXED, DO NOT CREATE NEW):
- `A1xxx`: 사망/장해
- `A3xxx`: 상해 후유장해
- `A4xxx`: 질병 진단 (암, 뇌졸중, 심장질환 등)
- `A5xxx`: 수술비
- `A6xxx`: 입원/통원
- `A9xxx`: 치료비 (항암, 표적 등)

**Event Number Ranges** (within category):
- `A4101-A4199`: 비암 질병 진단 (뇌졸중, 심장질환 등)
- `A4200-A4299`: 암 진단 관련
- `A4300-A4399`: 기타 질병 진단
- **A4900-A4999**: RESERVED (특수 케이스, 확장 금지 구역)**

### 3.2 Suffix Increment Rules

**Suffix Format**:
- `_1`, `_2`, `_3`, ..., `_9`: Variants within same event type
- `_001`, `_002`: Fine-grained sub-variants (rarely used)

**Increment Policy**:
1. **Sequential increment REQUIRED**: If `A4200_1` and `A4200_2` exist, next MUST be `A4200_3` (not `_5`)
2. **Maximum suffix: `_9`** (STEP13_5:122)
3. **Gap tolerance**: Gaps allowed if documented (e.g., `A4200_1`, `A4200_2`, `A4200_5` — `_3`, `_4` reserved)

**Prohibited Patterns**:
- ❌ `A4200_10` (exceeds _9 limit)
- ❌ `A4200_A` (non-numeric suffix)
- ❌ `A4200` → `A4299` (skipping without intermediate codes)

### 3.3 Relationship with STEP13 Cancer Policy

**Hierarchy**:
1. **This policy** (CANONICAL_CODE_EXTENSION_POLICY.md) — Constitutional level
2. **STEP13_CANCER_CANONICAL_POLICY.md** — Domain-specific (cancer only)
3. **STEP13_5_CANCER_EXCEL_OPERATION_RULES.md** — Operational rules (cancer only)

**Rules**:
- STEP13 applies ONLY to `A42xx` (cancer diagnosis) codes
- STEP13 Event Axis (Diagnosis/Re-diagnosis/Treatment/Surgery/Hospitalization) guides suffix assignment
- If conflict: This policy overrides STEP13
- If unspecified: STEP13 provides operational guidance for cancer domain

**Example**:
- STEP13 says: "A4200_Rx (신규 또는 파생 코드)" (STEP13_5:37)
- This policy says: "Suffix must be numeric _1 to _9" (3.2)
- **Resolution**: `A4200_Rx` is operational shorthand; actual code must be `A4200_N` where N ∈ [1,9]

---

## 4. 확장이 금지되는 경우 (MUST NOT Extend)

### 4.1 Search Failure as Reason

**Prohibited**:
```
Reason: "Evidence not found, creating new code for better search"
Result: ❌ DENIED
```

**Rationale**: Evidence search failure indicates:
- Alias mismatch (solvable by adding alias)
- Search key issue (solvable by normalization)
- Coverage not in evidence documents (legitimate not_found, no code needed)

**Correct Action**: Fix search/mapping, do NOT create new code.

### 4.2 Insurer-Specific Temporary Codes

**Prohibited**:
```
coverage_code: A4200_hanwha_temp
coverage_code: MER_001
```

**Rationale**: Canonical codes are cross-insurer identifiers. Insurer-specific codes violate canonical principle.

**Correct Action**: Identify canonical event, assign standard code, add insurer alias.

### 4.3 Arbitrary Prefix Creation

**Prohibited Patterns**:
- `A4999_1`, `A4999_2` — Using reserved range `A4900-A4999`
- `A4500_1` — Creating new hundred-level prefix without documentation
- `A7000_1` — Creating new category prefix `A7xxx`

**Rationale**:
- Reserved ranges (`x900-x999`) are for future structural needs, not operational gaps
- Hundred-level prefixes define semantic boundaries (e.g., `A4200` = cancer diagnosis)
- New prefixes require constitutional amendment, not operational decision

**Current Violation Analysis**:
```
Existing codes: A4101, A4102, A4103, A4104, A4105, A4200-A4210, A4299, A4301, A4302
Gap: A4211-A4298 (available)
Reserved: A4900-A4999
Violation: A4999_1, A4999_2 (in reserved range)
```

### 4.4 Exceeding Suffix Limit

**Prohibited**:
```
A4200_1, A4200_2, ..., A4200_9 all exist
Request: A4200_10
Result: ❌ DENIED
```

**Rationale**: Suffix limit `_9` enforces canonical consolidation. If 9 variants exist, coverage taxonomy needs restructuring, not 10th variant.

**Correct Action**: Create new hundred-level prefix (e.g., `A4210` for sub-category) or consolidate existing codes.

---

## 5. 절차 (Extension Approval Procedure)

### 5.1 Case Classification

**Case A: Alias Miss**
- Evidence found, canonical exists, alias missing
- **Action**: Add alias row to Excel, NO extension
- **Example**: `(20년갱신)갱신형...` → Add alias to existing `A4XXX_N`

**Case B: New Variant**
- Evidence found, canonical exists for category, different payment structure
- **Action**: Increment suffix within range, extension ALLOWED
- **Example**: `4대특정암진단비(제자리암)` → `A4209_3` (A4209 exists)

**Case C: New Coverage Type**
- Evidence found, no canonical category exists
- **Action**: Create new hundred-level prefix, extension CONDITIONALLY ALLOWED
- **Example**: (hypothetical) `희귀질환진단비` → `A4400_1` (if A4400 range available)

**Case D: Search Failure**
- Evidence not found, coverage in scope
- **Action**: Fix search/alias, NO extension
- **Example**: Exact match failed due to spacing → Normalize, add alias

### 5.2 Alias Viability Checklist

Before creating new code, MUST verify alias is impossible:

- [ ] Coverage name normalized (spacing, special chars removed)
- [ ] Checked all existing canonical names in same category
- [ ] Verified payment trigger is different (not just wording)
- [ ] Confirmed payment amount/frequency structure differs
- [ ] Searched Excel for similar 신정원코드명

**If ANY checkbox can be checked**: Use alias, DENY extension.

### 5.3 Extension Approval Checklist

For new code creation:

- [ ] Case classified as B (new variant) or C (new coverage type)
- [ ] Prefix falls within existing category range (A4200-A4299 for cancer diagnosis)
- [ ] Suffix increment is sequential or gap is documented
- [ ] Does NOT use reserved range (A4900-A4999)
- [ ] Suffix does NOT exceed _9
- [ ] STEP13 Event Axis identified (for cancer codes)
- [ ] No existing code can serve via alias

**ALL checkboxes must pass** for extension approval.

---

## 6. 과거 사례 정리 (Historical Precedents)

### 6.1 Commit 9c212d3 (2025-12-27) — 20 Codes Added

**Codes Added**:
- A4200_2, A4200_3, A4200_5 (암진단비 variants)
- A4209_2~7 (4대특정암진단비 variants)
- A4210_2 (유사암진단비)
- A5200_2, A5200_3, A5200_6, A5200_7 (암수술비 variants)
- A6200_2 (암입원일당)
- A9600_1, A9600_2 (암치료비)
- A9619_2, A9619_3 (표적항암약물치료비)
- A9621_1 (표적항암면역치료비)

**Classification**: Case B (new variants within existing categories)

**Justification**:
- Created with STEP13_CANCER_CANONICAL_POLICY.md in same commit
- All codes fall within established prefix ranges (A42xx, A52xx, A62xx, A96xx)
- Suffix increments follow sequential pattern (with documented gaps: A4200_5)
- Event Axis differentiation documented (STEP13_5)

**Ruling**: **ALLOWED (retroactively justified by STEP13 policy)**

**Notes**:
- STEP13 policy and code expansion co-created → policy documents expansion
- Suffix gaps (e.g., A4200_1, _2, _5) should be documented but acceptable
- No reserved range violation

### 6.2 Commit eb5dfd8 (STEP NEXT-35, 2025-12-31) — A4999_1, A4999_2

**Codes Added**:
- A4999_1: 갱신형 중증질환자(뇌혈관질환) 산정특례대상 진단비(연간1회한)
- A4999_2: 갱신형 중증질환자(심장질환) 산정특례대상 진단비(연간1회한)

**Classification**: Case B attempt (new variant) — **FAILED reserved range check**

**Justification Attempted** (STEP_NEXT_35_ALIAS_FIX.md:50):
- "New codes for 산정특례대상 진단비 (not previously in mapping file)"
- "Pattern follows existing diagnosis codes (A4101-A4210 range)"

**Constitutional Violation**:
1. ❌ **Reserved range violation**: A4900-A4999 is reserved (Section 3.1)
2. ❌ **Pattern deviation**: Existing A4xxx codes use A4101-A4302, not A4900+
3. ❌ **Available range ignored**: A4211-A4298 available, not used
4. ⚠️ **Alias not explored**: Could `(20년갱신)갱신형...` alias to existing A4301/A4302 (중증질환 range)?

**Ruling**: **CONDITIONALLY ALLOWED with MANDATORY REMEDIATION**

**Conditions**:
1. **Immediate**: A4999_1/2 codes function as-is (no rollback, no pipeline re-run)
2. **Within 30 days**: Reassign to proper range (A4300-A4399 for 중증질환 diagnosis)
3. **Future**: NO new A49xx codes without constitutional amendment
4. **Documentation**: Add deprecation notice to A4999_* rows in Excel

**Remediation Plan**:
- Proposed codes: `A4301_2` (뇌혈관질환 산정특례), `A4301_3` (심장질환 산정특례)
- Existing `A4301_1` suggests 중증질환 category already exists
- Migration: Add new codes, mark A4999_* as deprecated, update scope mappings in next pipeline run

---

## 7. 본 정책의 효력 (Policy Authority)

### 7.1 Effective Scope

**Applies to**:
- All canonical coverage codes (cre_cvr_cd) in `data/sources/mapping/담보명mapping자료.xlsx`
- All pipeline steps reading mapping Excel (Step2, Step4, Step5)
- All future code extensions (2025-12-31 onwards)
- All domain-specific policies (STEP13, future non-cancer policies)

**Does NOT apply to**:
- Coverage names (coverage_name_raw, coverage_name_canonical) — naming is flexible
- Insurer-specific aliases (담보명(가입설계서) column) — unlimited aliases allowed
- Evidence search logic (Step4) — search uses canonical, not code structure
- SSOT files (coverage_cards.jsonl) — generated, not manually editable

### 7.2 Amendment Process

**Constitutional-level changes** (prefix ranges, suffix limits, reserved ranges):
- MUST be documented in this file (CANONICAL_CODE_EXTENSION_POLICY.md)
- MUST include rationale and historical precedent analysis
- MUST NOT contradict CLAUDE.md scope gate principles

**Operational-level changes** (STEP13, domain-specific rules):
- MAY be documented in domain-specific policy files
- MUST NOT violate this policy
- MUST reference this policy for conflict resolution

### 7.3 Conflict Resolution

**Priority Order**:
1. **CLAUDE.md** (project constitution) — scope gate, INPUT contract definition
2. **This policy** (CANONICAL_CODE_EXTENSION_POLICY.md) — code structure rules
3. **Domain policies** (STEP13_CANCER_CANONICAL_POLICY.md) — category-specific rules
4. **Operational rules** (STEP13_5_CANCER_EXCEL_OPERATION_RULES.md) — execution procedures

**If conflict arises**:
- Higher-priority document prevails
- Ambiguity resolved by "most restrictive interpretation" (deny extension)
- Edge cases escalated to manual review with this policy as checklist

### 7.4 Retroactive Application

**Existing codes** (created before 2025-12-31):
- Grandfathered in current state
- Violations identified but NOT rolled back (unless causing operational failure)
- New rows added to existing codes MUST follow this policy

**Example**:
- A4999_1, A4999_2 exist → ALLOWED to remain (6.2 ruling)
- New request: A4999_3 → DENIED (reserved range)
- Correct action: Create A4301_2, A4301_3 instead

---

## 8. Policy Lock and Version Control

**Version**: 1.0
**Effective Date**: 2025-12-31
**Next Review**: 2026-03-31 (or when 50+ new codes added)

**Immutable Provisions** (cannot be changed without CLAUDE.md amendment):
- Section 1.2 (SSOT vs INPUT contract distinction)
- Section 3.1 (Category prefixes A1-A9)
- Section 4.3 (Reserved range A4900-A4999)

**Modifiable Provisions** (can be amended via this file update):
- Section 3.2 (Suffix increment rules) — if _9 limit proves insufficient
- Section 5 (Approval procedure) — if automation becomes possible
- Section 6 (Historical precedents) — add new cases as they occur

**Change Log**:
- 2025-12-31 v1.0: Initial constitutional policy created (STEP NEXT-36)

---

**END OF POLICY**

---

## STEP NEXT-35 Final Ruling

**Based on this policy, STEP NEXT-35 (A4999_1 / A4999_2) is classified as:**

**Conditionally Allowed**

**Reasons**:
1. **Violation Confirmed**: Codes A4999_1, A4999_2 violate Section 4.3 (reserved range A4900-A4999)
2. **Operational Necessity**: Meritz evidence matching required canonical code (Case B: new variant)
3. **Remediation Required**: Codes MUST be reassigned to A4301_2, A4301_3 within 30 days
4. **No Immediate Rollback**: Current mappings remain functional, pipeline results valid
5. **Future Prevention**: NO new A49xx codes allowed (Section 6.2 ruling)

**Action Items**:
- [ ] Add deprecation notice to A4999_1, A4999_2 rows in Excel
- [ ] Create A4301_2 (뇌혈관질환 산정특례 진단비) in proper range
- [ ] Create A4301_3 (심장질환 산정특례 진단비) in proper range
- [ ] Update Meritz scope mappings to use A4301_2/3 in next pipeline run
- [ ] Mark A4999_* as "DEPRECATED - use A4301_2/3" in 신정원코드명 column
