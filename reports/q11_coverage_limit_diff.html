<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q11: ì•”ì§ì ‘ì…ì›ë¹„ ë³´ì¥í•œë„ ì°¨ì´ ë¹„êµ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1a1a1a;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .summary-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .summary-card.has-difference {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .summary-card.no-difference {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .summary-card h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        .summary-card p {
            font-size: 14px;
            color: #666;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }

        .difference-item {
            background: #fff9e6;
            border-left: 3px solid #ffc107;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .difference-item strong {
            color: #d32f2f;
        }

        .common-item {
            background: #f0f7ff;
            border-left: 3px solid #2196f3;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        thead {
            background: #f8f9fa;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            font-weight: 600;
            color: #495057;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .highlight-diff {
            background: #fff3cd;
            font-weight: 600;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .meta-info {
            font-size: 12px;
            color: #999;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 3px;
            margin-left: 8px;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Q11: ì•”ì§ì ‘ì…ì›ë¹„ ë‹´ë³´ ì¤‘ ë³´ì¥í•œë„ê°€ ë‹¤ë¥¸ ìƒí’ˆ ì°¾ê¸°</h1>
        <div class="subtitle">A6200 (ì•”ì§ì ‘ì¹˜ë£Œì…ì›ë¹„) - 7ê°œ ë³´í—˜ì‚¬ ë¹„êµ (SSOT ê¸°ì¤€, table_id: 22)</div>

        <div id="loading" class="loading">
            ë°ì´í„° ë¡œë”© ì¤‘...
        </div>

        <div id="error" class="error" style="display:none;"></div>

        <div id="content" style="display:none;">
            <!-- Summary Card -->
            <div id="summaryCard" class="summary-card">
                <h2>ìš”ì•½</h2>
                <p id="summaryText">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            </div>

            <!-- Difference Section -->
            <div class="section" id="differenceSection" style="display:none;">
                <h3>ğŸ”´ ì°¨ì´ í¬ì¸íŠ¸ (Differences Only)</h3>
                <div id="differenceContent"></div>
            </div>

            <!-- Common Section -->
            <div class="section">
                <h3>ğŸ”µ ê³µí†µ ì¡°ê±´ (Common Rules)</h3>
                <div id="commonContent"></div>
            </div>

            <!-- Comparison Table -->
            <div class="section">
                <h3>ğŸ“Š ë³´í—˜ì‚¬ë³„ ë¹„êµ í…Œì´ë¸”</h3>
                <table id="comparisonTable">
                    <thead>
                        <tr>
                            <th>ë³´í—˜ì‚¬</th>
                            <th>ìƒí’ˆëª…</th>
                            <th>ìµœëŒ€ ì…ì›ì¼ìˆ˜</th>
                            <th>ìš”ì–‘ë³‘ì›</th>
                            <th>ìµœì†Œ ì…ì›ì¼ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <!-- Meta Info -->
            <div class="meta-info">
                <strong>ë°ì´í„° ì¶œì²˜:</strong> document_page_ssot (as_of_date: 2025-11-26)<br>
                <strong>ê²€ì¦:</strong> FOUND=21/21, contamination=0<br>
                <strong>API:</strong> /compare_v2?coverage_code=A6200&as_of_date=2025-11-26&ins_cds=N01,N03,N05,N08,N09,N10,N13<br>
                <strong>ìƒì„± ì‹œê°:</strong> <span id="timestamp"></span>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = 'http://localhost:8000';
        const COVERAGE_CODE = 'A6200';
        const AS_OF_DATE = '2025-11-26';
        const INS_CDS = 'N01,N03,N05,N08,N09,N10,N13';

        // Insurer coverage name mapping (from coverage_mapping_ssot)
        const INSURER_COVERAGE_NAMES = {
            'N01': 'ì•”ì§ì ‘ì¹˜ë£Œì…ì›ì¼ë‹¹(â…¡)(ìš”ì–‘ë³‘ì›ì œì™¸,1ì¼ì´ìƒ)',
            'N03': 'ì•”ì§ì ‘ì¹˜ë£Œì…ì›ë¹„(ìš”ì–‘ë³‘ì›ì œì™¸)(1-120ì¼)',
            'N05': 'ì•”ì§ì ‘ì¹˜ë£Œì…ì›ë¹„(ìš”ì–‘ë³‘ì›ì œì™¸)(1ì¼-180ì¼)',
            'N08': 'ì•” ì§ì ‘ì¹˜ë£Œ ì…ì›ì¼ë‹¹â…¡(1ì¼ì´ìƒ)(ìš”ì–‘ë³‘ì› ì œì™¸)',
            'N09': 'ì•”ì§ì ‘ì¹˜ë£Œì…ì›ì¼ë‹¹(1-180ì¼,ìš”ì–‘ë³‘ì›ì œì™¸)ë‹´ë³´',
            'N10': 'ì•”ì§ì ‘ì¹˜ë£Œì…ì›ì¼ë‹¹(ìš”ì–‘ì œì™¸,1ì¼ì´ìƒ180ì¼í•œë„)',
            'N13': 'ì•”ì§ì ‘ì¹˜ë£Œì…ì›ì¼ë‹¹â…¡(ìš”ì–‘ë³‘ì›ì œì™¸)(1ì¼ì´ìƒ180ì¼í•œë„)'
        };

        // Parse limit days from coverage name or excerpt
        function parseLimitDays(coverageName, excerpt) {
            // Priority 1: Coverage name patterns
            const patterns = [
                /\(1-(\d+)ì¼\)/,  // (1-120ì¼), (1-180ì¼)
                /\((\d+)ì¼\)/,    // (180ì¼)
                /(\d+)ì¼í•œë„/,    // 180ì¼í•œë„
                /1ì¼ì´ìƒ(\d+)ì¼í•œë„/  // 1ì¼ì´ìƒ180ì¼í•œë„
            ];

            for (const pattern of patterns) {
                const match = coverageName.match(pattern);
                if (match) {
                    return match[1] + 'ì¼';
                }
            }

            // Check for "1ì¼ì´ìƒ" without explicit limit
            if (coverageName.includes('1ì¼ì´ìƒ') && !coverageName.match(/\d+ì¼í•œë„/)) {
                return '1ì¼ì´ìƒ (í•œë„ ë¯¸ëª…ì‹œ)';
            }

            return 'ì •ë³´ ì—†ìŒ';
        }

        // Parse nursing hospital rule
        function parseNursingHospital(coverageName, excerpt) {
            if (coverageName.includes('ìš”ì–‘ë³‘ì›ì œì™¸') || coverageName.includes('ìš”ì–‘ì œì™¸')) {
                return 'ì œì™¸';
            }
            if (coverageName.includes('ìš”ì–‘ë³‘ì›í¬í•¨') || coverageName.includes('ìš”ì–‘í¬í•¨')) {
                return 'í¬í•¨';
            }
            return 'ì •ë³´ ì—†ìŒ';
        }

        // Parse min admission days
        function parseMinAdmission(coverageName, excerpt) {
            const patterns = [
                /(\d+)ì¼ì´ìƒ/,  // 1ì¼ì´ìƒ, 2ì¼ì´ìƒ, etc.
            ];

            for (const pattern of patterns) {
                const match = coverageName.match(pattern);
                if (match) {
                    return match[1] + 'ì¼ ì´ìƒ';
                }
            }

            // Check excerpt for waiting period (ë©´ì±…, ë³´ì¥ê°œì‹œ, etc.)
            if (excerpt && (excerpt.includes('90ì¼') || excerpt.includes('ë©´ì±…') || excerpt.includes('ë³´ì¥ê°œì‹œ'))) {
                return '1ì¼ ì´ìƒ (ë©´ì±…ê¸°ê°„ ìˆìŒ)';
            }

            return 'ì •ë³´ ì—†ìŒ';
        }

        // Detect differences
        function detectDifferences(insurers) {
            const limitDays = [...new Set(insurers.map(ins => ins.limitDays))];
            const nursingRules = [...new Set(insurers.map(ins => ins.nursingHospital))];
            const minAdmissions = [...new Set(insurers.map(ins => ins.minAdmission))];

            return {
                limitDaysDiff: limitDays.length > 1,
                nursingRuleDiff: nursingRules.length > 1,
                minAdmissionDiff: minAdmissions.length > 1,
                limitDaysValues: limitDays,
                nursingRulesValues: nursingRules,
                minAdmissionsValues: minAdmissions
            };
        }

        // Fetch and render data
        async function fetchAndRender() {
            try {
                const response = await fetch(`${API_BASE}/compare_v2?coverage_code=${COVERAGE_CODE}&as_of_date=${AS_OF_DATE}&ins_cds=${INS_CDS}`);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.insurer_rows || data.insurer_rows.length === 0) {
                    throw new Error('No insurer data found');
                }

                // Parse insurer data
                const insurers = data.insurer_rows.map(row => {
                    const coverageName = INSURER_COVERAGE_NAMES[row.ins_cd] || 'Unknown';
                    const excerpt = row.slots?.waiting_period?.excerpt || row.slots?.exclusions?.excerpt || '';

                    return {
                        ins_cd: row.ins_cd,
                        coverageName: coverageName,
                        limitDays: parseLimitDays(coverageName, excerpt),
                        nursingHospital: parseNursingHospital(coverageName, excerpt),
                        minAdmission: parseMinAdmission(coverageName, excerpt),
                        hasAllSlots: row.slots?.waiting_period?.status === 'FOUND' &&
                                    row.slots?.exclusions?.status === 'FOUND' &&
                                    row.slots?.subtype_coverage_map?.status === 'FOUND'
                    };
                });

                // Detect differences
                const diff = detectDifferences(insurers);

                // Render summary card
                const summaryCard = document.getElementById('summaryCard');
                const summaryText = document.getElementById('summaryText');

                if (diff.limitDaysDiff || diff.nursingRuleDiff || diff.minAdmissionDiff) {
                    summaryCard.classList.add('has-difference');
                    summaryText.innerHTML = `
                        <strong>ë³´ì¥í•œë„ ì°¨ì´ ìˆìŒ</strong>
                        <span class="badge badge-danger">DIFFERENCE FOUND</span><br>
                        ${insurers.length}ê°œ ë³´í—˜ì‚¬ ì¤‘ ë³´ì¥í•œë„ ì¡°ê±´ì´ ë‹¤ë¦…ë‹ˆë‹¤.
                    `;
                } else {
                    summaryCard.classList.add('no-difference');
                    summaryText.innerHTML = `
                        <strong>ë³´ì¥í•œë„ ì°¨ì´ ì—†ìŒ</strong>
                        <span class="badge badge-success">UNIFORM</span><br>
                        ${insurers.length}ê°œ ë³´í—˜ì‚¬ ëª¨ë‘ ë™ì¼í•œ ë³´ì¥í•œë„ ì¡°ê±´ì…ë‹ˆë‹¤.
                    `;
                }

                // Render difference section
                if (diff.limitDaysDiff || diff.nursingRuleDiff || diff.minAdmissionDiff) {
                    document.getElementById('differenceSection').style.display = 'block';
                    const diffContent = document.getElementById('differenceContent');
                    let diffHTML = '';

                    if (diff.limitDaysDiff) {
                        diffHTML += `
                            <div class="difference-item">
                                <strong>ì…ì›ì¼ìˆ˜ í•œë„ ì°¨ì´:</strong><br>
                                ${diff.limitDaysValues.map(val => {
                                    const count = insurers.filter(ins => ins.limitDays === val).length;
                                    const insList = insurers.filter(ins => ins.limitDays === val).map(ins => ins.ins_cd).join(', ');
                                    return `${val}: ${count}ê°œ ë³´í—˜ì‚¬ (${insList})`;
                                }).join('<br>')}
                            </div>
                        `;
                    }

                    if (diff.nursingRuleDiff) {
                        diffHTML += `
                            <div class="difference-item">
                                <strong>ìš”ì–‘ë³‘ì› ê·œì¹™ ì°¨ì´:</strong><br>
                                ${diff.nursingRulesValues.map(val => {
                                    const count = insurers.filter(ins => ins.nursingHospital === val).length;
                                    return `${val}: ${count}ê°œ ë³´í—˜ì‚¬`;
                                }).join('<br>')}
                            </div>
                        `;
                    }

                    if (diff.minAdmissionDiff) {
                        diffHTML += `
                            <div class="difference-item">
                                <strong>ìµœì†Œ ì…ì›ì¼ìˆ˜ ì°¨ì´:</strong><br>
                                ${diff.minAdmissionsValues.map(val => {
                                    const count = insurers.filter(ins => ins.minAdmission === val).length;
                                    return `${val}: ${count}ê°œ ë³´í—˜ì‚¬`;
                                }).join('<br>')}
                            </div>
                        `;
                    }

                    diffContent.innerHTML = diffHTML;
                }

                // Render common section
                const commonContent = document.getElementById('commonContent');
                let commonHTML = '';

                if (!diff.nursingRuleDiff) {
                    commonHTML += `
                        <div class="common-item">
                            <strong>ìš”ì–‘ë³‘ì› ì œì™¸ ì—¬ë¶€:</strong> ${diff.nursingRulesValues[0]}
                            <span class="badge badge-info">UNIFORM</span>
                        </div>
                    `;
                }

                if (!diff.minAdmissionDiff) {
                    commonHTML += `
                        <div class="common-item">
                            <strong>ìµœì†Œ ì…ì›ì¼ìˆ˜:</strong> ${diff.minAdmissionsValues[0]}
                            <span class="badge badge-info">UNIFORM</span>
                        </div>
                    `;
                }

                if (!diff.limitDaysDiff) {
                    commonHTML += `
                        <div class="common-item">
                            <strong>ìµœëŒ€ ì…ì›ì¼ìˆ˜:</strong> ${diff.limitDaysValues[0]}
                            <span class="badge badge-info">UNIFORM</span>
                        </div>
                    `;
                }

                if (commonHTML === '') {
                    commonHTML = `
                        <div class="common-item">
                            ëª¨ë“  ì¡°ê±´ì—ì„œ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. ìœ„ "ì°¨ì´ í¬ì¸íŠ¸" ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”.
                        </div>
                    `;
                }

                commonContent.innerHTML = commonHTML;

                // Render comparison table
                const tableBody = document.getElementById('tableBody');
                insurers.forEach(ins => {
                    const row = document.createElement('tr');

                    // Highlight differences
                    const limitDaysClass = diff.limitDaysDiff ? 'highlight-diff' : '';
                    const nursingClass = diff.nursingRuleDiff ? 'highlight-diff' : '';
                    const minAdmissionClass = diff.minAdmissionDiff ? 'highlight-diff' : '';

                    row.innerHTML = `
                        <td>${ins.ins_cd}</td>
                        <td>${ins.coverageName}</td>
                        <td class="${limitDaysClass}">${ins.limitDays}</td>
                        <td class="${nursingClass}">${ins.nursingHospital}</td>
                        <td class="${minAdmissionClass}">${ins.minAdmission}</td>
                    `;
                    tableBody.appendChild(row);
                });

                // Update timestamp
                document.getElementById('timestamp').textContent = new Date().toLocaleString('ko-KR');

                // Show content, hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', fetchAndRender);
    </script>
</body>
</html>
